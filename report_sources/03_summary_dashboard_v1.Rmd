---
title: "Go.Data Summary Dashboard - DEMO V1"
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
    flexdashboard::flex_dashboard:
      theme: cosmo
      orientation: rows
      
---


<style>                     
.navbar {
  background-color:#4db0a0;
  border-color:white;
}
.navbar-brand {
color:white!important;
}
</style>   

<style type="text/css">

.chart-title {  /* chart_title  */
   font-size: 18px

</style>



```{r setup, include=FALSE}

pacman::p_load(
  tidyverse,    # includes many packages for tidy data wrangling and presentation
  janitor, # tables and data cleaning
  here,
  rio,
  lubridate,
  htmlwidgets,
  flexdashboard,
  formattable,
  kableExtra,
  RColorBrewer, 
  viridis,
  qdapTools,
  incidence2
)


output_dir <- "../report_outputs"


```

```{r load_data, include = FALSE}
cases <- rio::import(here::here("data", "clean", "cases_clean.rds")) %>%
  as_tibble()

contacts <- rio::import(here::here("data", "clean", "contacts_clean.rds")) %>%
  as_tibble()

contacts_of_contacts <- rio::import(here::here("data", "clean", "contacts_of_contacts_clean.rds")) %>%
  as_tibble()

relationships <- rio::import(here::here("data", "clean", "relationships_clean.rds")) %>%
  as_tibble()

lab_results <- rio::import(here::here("data", "clean", "lab_results_clean.rds")) %>% as_tibble() %>%
  as_tibble()

events <- rio::import(here::here("data", "clean", "events_clean.rds")) %>%
  as_tibble()

followups <- rio::import(here::here("data", "clean", "followups_clean.rds")) %>%
  as_tibble()

users <- rio::import(here::here("data", "clean", "users_clean.rds")) %>%
  as_tibble()

teams <- rio::import(here::here("data", "clean", "teams_clean.rds")) %>%
  as_tibble()

locations <- rio::import(here::here("data", "clean", "locations_clean.rds")) %>%
  as_tibble()


```

```{r define_time_periods, include = FALSE}
database_date <- Sys.Date()  
database_week <- isoweek(database_date)
prev_1_date <- database_date - 1
prev_7_date <- prev_1_date - 7
before_prev_7_date <- prev_7_date -7
```


```{r themes, include = FALSE}
# Create cusotmized color scales for graphs and tables
custom_green0 = "#E3FCEE"
custom_green = "#71CA97"
custom_red0 = "#FFAAAA"
custom_red = "#ff7f7f"
custom_grey0 = "#ADADAD"
custom_grey = "#818181"
custom_orange0 = "#FFD6CA"
custom_orange = "#FF9270"
custom_blue0 = "#79C5FF"
custom_blue = "#004F8B"
godata_orange = "#ff884d"
godata_green = "#4db0a0"


scale_status <- scale_fill_manual(
    "Status",
    values = c(seen            = "#71CA97",
               not_seen        = "#5d6d75",
               not_performed   = "#D3C9C6",
               seen_no_signs   = "#A0E2BD",
               seen_with_signs = "#E94B25",
               missed          = "#020202"),
                
    labels = c(seen            = "Seen",
               not_seen        = "Not Seen",
               not_performed   = "Not Performed",
               seen_no_signs   = "Seen OK",
               seen_with_signs = "Seen Not OK",
               missed          = "Missed"))

statuscols <- c(missed = 0, 
                seen_with_signs = 0, 
                seen_no_signs = 0,
                not_seen = 0,
                not_performed = 0)

completioncols <- c(completed = 0,
                    partial = 0,
                    not_attempted = 0)

scale_completion <- scale_fill_manual(
  name = "Completed",
  values = c("#E94B25",
             "#ABADAB"),
  labels = c("Incomplete",
             "Completed"))

scale_risk_factors <- scale_fill_manual(
  name = "Status",
  values = c("#ff5c33",
             "#c2d6d6",
             custom_grey0),
  
  labels = c("Yes",
             "No",
             "Unknown"))


scale_classification <- scale_fill_manual(
  "Classification",
  values = c(CONFIRMED             = "#F55927",
             NOT_A_CASE_DISCARDED  = "#DADAD9",
             PROBABLE              = "#5C77B6",
             SUSPECT               = "#6CBBC6"),
  
  labels = c(CONFIRMED             = "Confirmed",
             NOT_A_CASE_DISCARDED  = "Not A Case",
             PROBABLE              = "Probable",
             SUSPECT               = "Suspect"))


scale_test <- scale_fill_manual(
  "Tests",
  values = c(POSITIVE        = "#F55927",
             NEGATIVE    = "#DADAD9",
             PENDING = "#F6DDCC",
             INCONCLUSIVE = "#FBEEE6"
             
  ),
  
  labels = c(POSITIVE        = "Positive",
             NEGATIVE     = "Negative",
             PENDING     = "Pending",
             INCONCLUSIVE     = "Unknown/Inconclusive"
             
  ))


scale_day <- ggplot2::scale_x_date(breaks = "3 days",
                                   expand=c(0,0),
                                   date_label = format("%d %b %Y"))

```

```{r case_linelist, include = FALSE}

# user list to join
user_namelist <- users %>%
  mutate(user_name = paste0(first_name, " ", last_name)) %>%
  select(id,user_name)

team_namelist <- teams %>%
  select(id, team_name = name)


# visit status from followups
contacts_seen_ever <- followups %>%
  filter(followup_status == "SEEN_OK" | followup_status == "SEEN_NOT_OK") %>%
  arrange(contact_id, desc(date)) %>%
  distinct(contact_id, .keep_all = TRUE) %>%
  select(contact_id,
         contact_visual_id, 
         date_of_last_followup_seen = date)

contacts_last_visit <- followups %>%
  arrange(contact_id, desc(date)) %>%
  distinct(contact_id, .keep_all = TRUE) %>%
  select(contact_id,
         contact_visual_id, 
         date_of_last_followup = date,
         status_of_last_followup = followup_status)

contact_linelist_status <- contacts %>%
  left_join(user_namelist, by = c("updated_by" = "id")) %>%
  left_join(team_namelist, by = c("follow_up_team_id" = "id")) %>%
  left_join(select(contacts_seen_ever, contact_id, date_of_last_followup_seen), by = c("id" = "contact_id")) %>%
  left_join(select(contacts_last_visit, contact_id, date_of_last_followup, status_of_last_followup), by = c("id" = "contact_id")) %>%
  
  # mutate_if(is_character, funs(na_if(.,""))) %>%
  mutate(days_since_followup_seen = difftime(database_date,
                                             date_of_last_followup_seen, 
                                             units = "day")) %>%
  mutate(days_since_exp = difftime(database_date,
                                   date_of_last_contact, 
                                   units = "day")) %>%
  mutate(seen_with_signs = case_when(
    status_of_last_followup == "SEEN_NOT_OK" ~ TRUE,
    # & date_of_last_followup == database_date ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(seen_without_signs = case_when(
    status_of_last_followup == "SEEN_OK" ~ TRUE,
    # & date_of_last_followup == database_date ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(missed = case_when(
    status_of_last_followup == "MISSED" ~ TRUE,
    # & date_of_last_followup == database_date ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(no_action = case_when(
    (status_of_last_followup == "NOT_ATTEMPTED" |
       status_of_last_followup == "NOT_PERFORMED" ) ~ TRUE,
    # & date_of_last_followup == database_date ~ TRUE,
    TRUE ~ FALSE)) %>%
  # mutate(vaccine = (contact_status_linelist$contact_id %in% contacts_vaccinated_ever$contact_id)) %>%
  mutate(lost_to_followup = case_when(
    days_since_followup_seen >= 3 ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(second_week_followup = case_when(
    days_since_exp < 15
    & days_since_exp >= 8 ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(first_week_followup = case_when(
    days_since_exp < 8 ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(never_seen = !(id %in% contacts_seen_ever$contact_id)) 


# set totals for value boxes
total_cases_reg <- cases %>%
  filter(classification != "NOT_A_CASE_DISCARDED") %>%
  count()


## New cases, last 7 days
cases_reg_last7d <- cases %>%
  filter(date_of_reporting >= prev_7_date) %>%
  count()

cases_reg_prev_last7d <- cases %>%
  filter(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date) %>%
  count()

perc_change_7d <- round(((cases_reg_last7d - cases_reg_prev_last7d) / cases_reg_prev_last7d)*100, digits = 0) 
perc_change_7d <- sprintf("%+3.0f %%", perc_change_7d)

# Total cases CONFIRMED
total_cases_confirmed <- cases %>%
  filter(classification == "CONFIRMED") %>%
  count()

# Total cases PROBABLE
total_cases_probable <- cases %>%
  filter(classification == "PROBABLE") %>%
  count()

# Total cases SUSPECT
total_cases_suspect <- cases %>%
  filter(classification == "SUSPECT") %>%
  count()

# Cases from contact list
cases_from_known_contact <- cases %>%
  filter(was_contact) %>%
  count()

cases_from_known_contact_last7d <- cases %>%
  filter(date_of_reporting >= prev_7_date) %>%
  filter(was_contact) %>%
  count()

perc_from_known_contact <-
  round((cases_from_known_contact / total_cases_reg)*100, digits = 1)

perc_from_known_contact_last7d <-
  round((cases_from_known_contact_last7d / cases_reg_last7d)*100, digits = 1)

# Cases died / recovered
cases_died <- cases %>%
  filter(outcome == "DECEASED") %>%
  count()

cases_recovered <- cases %>%
  filter(outcome == "RECOVERED") %>%
  count()

# Cases hospitalized
cases_hospitalized <- cases %>%
  filter(hospitalized) %>%
  count()

# Cases with No Epi Link
cases_no_epi_link <- cases %>%
  filter(!known_epi_link) %>%
  count()

# Cases with No Epi Link, last 7d
cases_no_epi_link_last7d <- cases %>%
  filter(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date) %>%
  filter(!known_epi_link) %>%
  count()

# Cases 0 contacts
cases_no_contacts <- cases %>%
  filter(no_contacts == 0) %>%
  count()


# Active contacts
total_contacts_reg <- contact_linelist_status %>%
  count() 

contacts_active <- contact_linelist_status %>%
  filter(follow_up_status == "UNDER_FOLLOW_UP") %>%
  count() 

# New contacts listed, last 7 days
contacts_reg_last7d <- contacts %>%
  filter(date_of_reporting >= prev_7_date) %>%
  count()

contacts_reg_prev_last7d <- contacts %>%
  filter(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date) %>%
  count()

perc_change_7d_contacts <- round(((contacts_reg_last7d - contacts_reg_prev_last7d) / contacts_reg_prev_last7d)*100, digits = 0) 
perc_change_7d_contacts <- sprintf("%+3.0f %%", perc_change_7d_contacts)

# Contacts followed
contacts_active_followed <- contact_linelist_status %>%
  filter(follow_up_status == "UNDER_FOLLOW_UP") %>%
  filter(seen_with_signs | seen_without_signs) %>%
  count()

perc_contacts_active_followed <-
  round((contacts_active_followed/contacts_active)*100,digits = 1)

# Contacts lost to follow up
contacts_active_ltfu <- contact_linelist_status %>%
  filter(follow_up_status == "UNDER_FOLLOW_UP") %>%
  filter(lost_to_followup) %>%
  count()

perc_contacts_active_ltfu <-
  round((contacts_active_ltfu/contacts_active)*100,digits = 1)



```


DEMOGRAPHICS {data-icon="fa-users"} 
=====================================================

Row {data-height=125}
-------------------------------------

### Total Cases
```{r total_cases_reg, echo = FALSE}

valueBox(total_cases_reg, 
         icon = "fa-user-plus", 
         caption = "Total Confirmed Cases",
         color = godata_orange)
```

### New Cases, last 7d
```{r cases_reg_last7d, echo = FALSE}


valueBox(cases_reg_last7d, 
         caption = "New Cases, Last 7d",
         color = custom_grey0)

```


### Cases from Contact List
```{r perc_from_known_contact, echo = FALSE}

valueBox(paste0(perc_from_known_contact,"%"), 
         caption = "Cases from known contacts",
         color =  custom_grey0)
```

### Cases with contacts listed/contacted within 48hrs
```{r cases_contacts_listed_48hr, echo = FALSE}

valueBox(paste0("5%"),
         caption = "Cases with contacts listed within 48hrs",
         color =  custom_grey0)

```


### Cases Died 
```{r cases_died, echo = FALSE}

valueBox(cases_died,
         caption = "Cases died",
         color = custom_grey0)
```



### Cases Recovered 
```{r cases_recovered, echo = FALSE}

valueBox(cases_recovered,
         caption = "Cases recovered",
         color = custom_grey0)
```


### Active Contacts
```{r total_active_contacts_reg, echo = FALSE}

valueBox(contacts_active, 
         icon = "fa-users",
         color = godata_orange)
```

### New Contacts Listed, last 7d
```{r contacts_reg_last7d, echo = FALSE}

valueBox(contacts_reg_last7d, 
         caption = "New Contacts Listed, Last 7d",
         color = custom_grey0)
```

### Contacts Followed
```{r contacts_active_followed, echo = FALSE}

valueBox(paste0(perc_contacts_active_followed,"%"),
         caption = "Active Contacts Followed",
          color = custom_grey0)
```

### Contacts Lost To Follow Up

```{r contacts_active_ltfu, echo = FALSE}

valueBox(paste0(perc_contacts_active_ltfu,"%"),
         caption = "Active Contacts LTFU",
          color = custom_grey0)
```


Row {.tabset data-height=875}
-------------------------------------

### Case Demographics

```{r case_demographics, fig.width=9, fig.height=6, out.width="50%"}
### count those without reported age or sex or occupation
case_unknown_age <- sum(cases$age_class == "unknown")
case_unknown_sex <- sum(is.na(cases$gender))
case_with_age_and_sex <- sum(!is.na(cases$gender) & cases$age_class != "unknown") 

#############################################################
### case age breakdown over time
############################################################
cases$date_of_reporting <- as.Date(cases$date_of_reporting)
cases_per_week <- cases %>%
  filter(age_class != "unknown") %>%
  mutate(iso_week = isoweek(date_of_reporting)) %>%
  filter(iso_week < database_week & iso_week >= 20) %>%
  group_by(iso_week) %>%
  summarise(weekly_total = n()) 
cases$age_class_v2 <- fct_collapse(cases$age_class, 
                          "0-4" = c("0-4"), 
                          "5-14" = c("5-9", "10-14"), 
                          "15-39" = c("15-19", "20-29","30-39"), 
                          "40-64" = c("40-49", "50-59","60-64"), 
                          "65-79" = c("65-69", "70-74","75-79"),
                          "80+" = "80+")
case_age_breakdown_over_time <- cases %>%
  mutate(iso_week = isoweek(date_of_reporting)) %>%
  filter(age_class != "unknown",
         iso_week < database_week) %>%
         # iso_week >= (database_week-15)) %>%
  mutate(week_of_reporting = as.Date(cut(date_of_reporting, breaks = "week"))) %>%
  group_by(week_of_reporting, iso_week, age_class_v2) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  inner_join(cases_per_week, by = "iso_week") %>%
  mutate(prop = count/weekly_total*100)
case_age_breakdown_over_time_plot <- 
  ggplot(case_age_breakdown_over_time, aes(x = week_of_reporting, y = count, fill = age_class_v2 )) +
  # geom_line(size = 1.3) +
  geom_area(aes(fill = age_class_v2), colour="white") +
  scale_fill_viridis(discrete = T, option = "magma") +
  scale_x_date(date_breaks = "2 weeks",
               date_labels = "%b %d",
               limits = c(min(case_age_breakdown_over_time$week_of_reporting), max(case_age_breakdown_over_time$week_of_reporting))) +
  ylim(0,NA) +
  theme_minimal() +
  labs(x = "",
       y = "",
       fill = "Age group",
       title = "Age breakdown of COVID-19 cases by reporting week",
       subtitle = paste0("n = ", case_unknown_age, " with no age recorded")
       ) + 
  theme(
    legend.title = element_text(size=10, face = "bold"),
    plot.title = element_text(size=12, face = "bold"),
    axis.ticks.y.left = element_line(size = 0.5, colour = "grey"),
    axis.ticks.x = element_blank(),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.subtitle = element_text(size=11),
    plot.caption = element_text(size = 8, face = "italic"),
    panel.grid.major.y = element_line(size = 0.2, colour = "grey"),
    panel.grid = element_blank())

############################################################
## epi curve date of onset
############################################################

# create the incidence object, aggregating cases by day
  epi_date_of_onset <- incidence(       # create incidence object
    x = cases,             # dataset
    date_index = date_of_onset,  # date column
    groups = classification,
    interval = "day"          # date grouping interval
  )
  
  epicurve_date_of_onset <-
    plot(epi_date_of_onset,
         fill = classification,                       # box/bar color,
         legend = "top",                       # legend on top
         title = "Epidemic curve by Date of Onset",  # title
         xlab = "Day of onset",               # x-axis label
         show_cases = FALSE,                    # show each case as an individual box
         alpha = 0.7,                          # transparency 
         n.breaks = 20,
         border = "grey",                      # box border
         angle = 45,                           # angle of date labels
         centre_dates = FALSE,                 # date labels at edge of bar
         date_format = "%d %b %Y") + # adjust how dates are displayed 
    scale_y_continuous(expand = c(0,0)) +      # y-axis
    
    labs(                               
      subtitle = stringr::str_glue(                            
        "n = {total_case_count} 
        {missing_onset} cases are missing date of onset and not shown",
        total_case_count = nrow(cases),
        missing_onset = nrow(cases %>% filter(is.na(date_of_onset))))) +
    theme(
      legend.title = element_text(size=10, face = "bold"),
      plot.title = element_text(size=12, face = "bold"),
      #axis.ticks.x = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.subtitle = element_text(size=11),
      plot.caption = element_text(size = 8, face = "italic"),
      panel.grid = element_blank(),
      axis.ticks.y.left = element_line(size = 0.5, colour = "grey"),
      panel.grid.major.y = element_line(size = 0.2, colour = "grey"))

#############################################################
### age sex pryamid
############################################################
case_age_sex_breakdown <- cases %>%
  filter(age_class != "unknown") %>%
  filter(!is.na(gender)) %>%
  group_by(gender, age_class) %>%
  summarise(num = n()) %>%
  ungroup() %>%
  mutate(prop_case = num / sum(num) * 100)
drop_levels <- levels(droplevels(case_age_sex_breakdown$age_class))
age_pyramid_case <- 
  ggplot(data = case_age_sex_breakdown, aes(x = age_class, fill = gender)) + 
  geom_bar(data = subset(case_age_sex_breakdown, gender == "FEMALE"), aes(y = prop_case),
           stat = "identity",width=1,  alpha = 0.6, col = "white") +
  geom_bar(data = subset(case_age_sex_breakdown, gender == "MALE"),
           stat = "identity",width=1,  aes(y = prop_case*(-1)), alpha = 0.6, col = "white") +
  geom_label(
    label= paste0(round(sum(case_age_sex_breakdown$prop_case[case_age_sex_breakdown$gender == "MALE"]),digits=1),"% Male"),
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.4,
    x=13,
    y=7,
    color = "white",
    fill="#00bfbf"
  ) +
  geom_label(
    label= paste0(round(sum(case_age_sex_breakdown$prop_case[case_age_sex_breakdown$gender == "FEMALE"]),digits=1),"% Female"), 
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.4,
    x=12,
    y=7,
    color = "white",
    fill="#005252"
  ) +
  geom_label(
    label= paste0(round(case_unknown_sex/total_cases_reg,digits=2),"% Unknown"), 
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.4,
    x=11,
    y=7,
    color = "white",
    fill=custom_grey
  ) +
  scale_fill_manual(
    values=c(
      "MALE" = "#00bfbf", 
      "FEMALE" = "#005252"),
    guide = guide_legend(reverse = TRUE)
  ) + 
  coord_flip() + 
  theme_classic() +
  # theme_pubr() + 
  
  labs(y = "Percent of total",
       x = "",
       fill = "Sex",
       title = "Age/sex pyramid of COVID-19 cases",
       subtitle = paste0("n = ", case_unknown_age, " with no age recorded, n = ", case_unknown_sex, " with no sex recorded")) +
       # caption = paste0("Source: Go.Data Core Case Registration Module 
       #      Excludes cases without reported age (n = ", case_unknown_age, ") and sex (n = ", case_unknown_sex, ")")) 
  scale_x_discrete(limits = rev(drop_levels)) +
  theme(
    legend.title = element_text(size=10, face = "bold"),
    plot.title = element_text(size=12, face = "bold"),
    axis.ticks.y.left = element_line(size = 0.5, colour = "grey"),
    axis.title.y = element_text(size = 12),
    plot.subtitle = element_text(size=11),
    plot.caption = element_text(size = 8, face = "italic"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()) 
  
#############################################################
### occupation pie chart
############################################################
cases$occupation <- as.factor(cases$occupation)
case_unknown_occupation <- sum(is.na(cases$occupation) | cases$occupation == "UNKNOWN")
case_other_occupation <- sum(cases$occupation == "OTHER")   ### why is this not working??
case_occupation_breakdown <- cases %>%
  # filter(!is.na(occupation),
  #        occupation != "OTHER") %>%
  group_by(occupation) %>%
  count() %>%
  arrange(desc(n)) 
# case_occupation_breakdown_plot_freq <- 
#   ggplot(subset(case_occupation_breakdown, !is.na(occupation)), aes(x = occupation, y = n)) +
#   geom_bar(stat = "identity") +
#   coord_flip() +
#   theme_classic()
color_count = length(unique(cases$occupation))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))
case_occupation_pie_chart <-
  ggplot(subset(case_occupation_breakdown, !is.na(occupation) & !(occupation == "OTHER")), aes(x = "", y = n, fill = occupation)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start = 0) +
  theme_minimal() +
  scale_fill_manual(values = getPalette(color_count)) +
  labs(
       fill = "Occupation",
       title = "Occupational breakdown of COVID-19 cases",
       subtitle = paste0("n = ", case_unknown_occupation," without occupation recorded,", " n = ", case_other_occupation," where 'OTHER'")
       ) +
  theme(axis.line = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        legend.position = "right",
        legend.title = element_text(size=10, face = "bold"),
        plot.title = element_text(size=12, face = "bold"),
        plot.subtitle = element_text(size=11),
        plot.caption = element_text(size = 8, face = "italic"))
#############################################################
### high risk groups
############################################################
cases_high_risk <- cases %>%
  mutate(
    health_worker_yes = case_when(occupation == "HEALTH_CARE_WORKER" |
                              occupation == "HEALTH_LABORATORY_WORKER" ~ TRUE,
                              TRUE ~ FALSE),
    health_worker_unknown = case_when(occupation == "UNKNOWN" |
                              is.na(occupation) ~ TRUE,
                              TRUE ~ FALSE),
    
    pregnant_yes = case_when(str_detect(pregnancy_status, "YES_") ~ TRUE,
                              TRUE ~ FALSE),
    
        pregnant_unknown = case_when(is.na(pregnancy_status) ~ TRUE,
                              TRUE ~ FALSE),
    
    high_risk_yes = case_when(risk_level == "3_HIGH" ~ TRUE,
                              TRUE ~ FALSE),
    
            risk_unknown = case_when(is.na(risk_level) ~ TRUE,
                              TRUE ~ FALSE)
    
  ) %>%
  summarize(health_worker_yes = sum(health_worker_yes),
            health_worker_unknown = sum(health_worker_unknown),
            pregnant_yes = sum(pregnant_yes),
            pregnant_unknown = sum(pregnant_unknown),
            high_risk_yes = sum(high_risk_yes),
            risk_unknown = sum(risk_unknown),
            total = nrow(cases)) %>%
    mutate(
         health_worker_no = total - health_worker_yes - health_worker_unknown,
         pregnant_no = total - pregnant_yes - pregnant_unknown,
         high_risk_no = total - high_risk_yes - risk_unknown) %>%
  pivot_longer(-total,
    names_to = "category", values_to = "count") %>%
  
  mutate(risk_factor = case_when(str_detect(category,"health_worker") ~ "Health Worker",
                                str_detect(category,"pregnant") ~ "Pregnant",
                                 str_detect(category,"risk") ~ "Risk Level = `High`")
                      ) %>%
    mutate(category = case_when(str_detect(category,"_yes") ~ "Yes",
                               str_detect(category,"_no") ~ "No",
                                str_detect(category,"_unknown") ~ "Unknown")
                      ) %>%
  
  mutate(prop = (count/total*100)) %>%
  arrange(risk_factor, category)
cases_high_risk$category<-factor(cases_high_risk$category, levels=c('Unknown','No','Yes'), ordered = TRUE)
plot_cases_high_risk <- 
  ggplot(cases_high_risk, aes(x = risk_factor, y = count, fill = category)) + 
  geom_col() +
  coord_flip() +
  labs(x = " ",
       y = "# of cases",
       title = "Groups of interest among registered cases",
       subtitle = "Proportion of records with relevant fields marked YES") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12, face = "bold"),
        plot.subtitle = element_text(size = 11)) +
  scale_fill_manual(
    values=c(
      "Yes" = "#ff5c33", 
      "No" = "#c2d6d6",
      "Unknown" = custom_grey0),
    guide = guide_legend(reverse = TRUE))  
  
#########################################
# case_age_breakdown_over_time_plot
epicurve_date_of_onset
age_pyramid_case
case_occupation_pie_chart
plot_cases_high_risk
```

### Contact Demographics

```{r contact_demographics, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}
### count those without reported age or sex or occupation
contact_unknown_age <- sum(contacts$age == "unknown")
contact_unknown_sex <- sum(is.na(contacts$gender))
contact_with_age_and_sex <- sum(!is.na(contacts$gender) & contacts$age_class != "unknown") 
#############################################################
### contact age breakdown over time
############################################################
contacts$date_of_reporting <- as.Date(contacts$date_of_reporting)
contacts_per_week <- contacts %>%
  filter(age_class != "unknown") %>%
  mutate(iso_week = isoweek(date_of_reporting)) %>%
  filter(iso_week < database_week & iso_week >= 20) %>%
  group_by(iso_week) %>%
  summarise(weekly_total = n()) 
contacts$age_class_v2 <- fct_collapse(contacts$age_class, 
                          "0-4" = c("0-4"), 
                          "5-14" = c("5-9", "10-14"), 
                          "15-39" = c("15-19", "20-29","30-39"), 
                          "40-64" = c("40-49", "50-59","60-64"), 
                          "65-79" = c("65-69", "70-74","75-79"),
                          "80+" = "80+")
contact_age_breakdown_over_time <- contacts %>%
  mutate(iso_week = isoweek(date_of_reporting)) %>%
  filter(age_class != "unknown",
         iso_week < database_week) %>%
         # iso_week >= (database_week-15)) %>%
  mutate(week_of_reporting = as.Date(cut(date_of_reporting, breaks = "week"))) %>%
  group_by(week_of_reporting, iso_week, age_class_v2) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  inner_join(contacts_per_week, by = "iso_week") %>%
  mutate(prop = count/weekly_total*100)
contact_age_breakdown_over_time_plot <- 
  ggplot(contact_age_breakdown_over_time, aes(x = week_of_reporting, y = count, fill = age_class_v2 )) +
  # geom_line(size = 1.3) +
  geom_area(aes(fill = age_class_v2), colour="white") +
  scale_fill_viridis(discrete = T, option = "magma") +
  scale_x_date(date_breaks = "2 weeks",
               date_labels = "%b %d",
               limits = c(min(contact_age_breakdown_over_time$week_of_reporting), max(contact_age_breakdown_over_time$week_of_reporting))) +
  ylim(0,NA) +
  theme_minimal() +
  labs(x = "",
       y = "",
       fill = "Age group",
       title = "Age breakdown of COVID-19 contacts by reporting week",
       subtitle = paste0("n = ", contact_unknown_age, " with no age recorded")
       ) + 
  theme(
    legend.title = element_text(size=10, face = "bold"),
    plot.title = element_text(size=12, face = "bold"),
    axis.ticks.y.left = element_line(size = 0.5, colour = "grey"),
    axis.ticks.x = element_blank(),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.subtitle = element_text(size=11),
    plot.caption = element_text(size = 8, face = "italic"),
    panel.grid.major.y = element_line(size = 0.2, colour = "grey"),
    panel.grid = element_blank())

###########################################################
## contacts reg over time
##########################################################
# create the incidence object
  contacts_by_reg <- incidence(       # create incidence object
    x = contacts,             # dataset
    date_index = date_of_reporting,  # date column
    interval = "day"          # date grouping interval
  )
  
  plot_contacts_by_reg <-
    plot(contacts_by_reg,                       # box/bar color,
         legend = "top",                       # legend on top
         title = "Contacts Listed by Date of Reporting",  # title
         xlab = "Day of reporting",               # x-axis label                   
         alpha = 0.7,                          # transparency 
         n.breaks = 20,
         border = "grey",                      # box border
         angle = 45,                           # angle of date labels
         centre_dates = FALSE,                 # date labels at edge of bar
         date_format = "%d %b %Y") + # adjust how dates are displayed 
    scale_y_continuous(expand = c(0,0)) +      # y-axis
    
    labs(                               
      subtitle = stringr::str_glue(                            
        "n = {total_contact_count}",
        total_contact_count = nrow(contacts))) +
    theme(
      legend.title = element_text(size=10, face = "bold"),
      plot.title = element_text(size=12, face = "bold"),
      #axis.ticks.x = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.subtitle = element_text(size=11),
      plot.caption = element_text(size = 8, face = "italic"),
      panel.grid = element_blank(),
      axis.ticks.y.left = element_line(size = 0.5, colour = "grey"),
      panel.grid.major.y = element_line(size = 0.2, colour = "grey"))
  
#############################################################
### age sex pryamid
############################################################
contact_age_sex_breakdown <- contacts %>%
  filter(age_class != "unknown") %>%
  filter(!is.na(gender)) %>%
  group_by(gender, age_class) %>%
  summarise(num = n()) %>%
  ungroup() %>%
  mutate(prop = num / sum(num) * 100)
drop_levels <- levels(droplevels(contact_age_sex_breakdown$age_class))
age_pyramid_contact <- 
  ggplot(data = contact_age_sex_breakdown, aes(x = age_class, fill = gender)) + 
  geom_bar(data = subset(contact_age_sex_breakdown, gender == "FEMALE"), aes(y = prop),
           stat = "identity",width=1,  alpha = 0.6, col = "white") +
  geom_bar(data = subset(contact_age_sex_breakdown, gender == "MALE"),
           stat = "identity",width=1,  aes(y = prop*(-1)), alpha = 0.6, col = "white") +
  geom_label(
    label= paste0(round(sum(contact_age_sex_breakdown$prop[contact_age_sex_breakdown$gender == "MALE"]),digits=1),"% Male"),
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.4,
    x=13,
    y=7,
    color = "white",
    fill="#ffac81"
  ) +
  geom_label(
    label= paste0(round(sum(contact_age_sex_breakdown$prop[contact_age_sex_breakdown$gender == "FEMALE"]),digits=1),"% Female"), 
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.4,
    x=12,
    y=7,
    color = "white",
    fill="#e26d5c"
  ) +
  geom_label(
    label= paste0(round(contact_unknown_sex/total_contacts_reg,digits=2),"% Unknown"), 
    label.padding = unit(0.55, "lines"), # Rectangle size around label
    label.size = 0.4,
    x=11,
    y=7,
    color = "white",
    fill=custom_grey
  ) +
  scale_fill_manual(
    values=c(
      "MALE" = "#ffac81", 
      "FEMALE" = "#e26d5c"),
    guide = guide_legend(reverse = TRUE)
  ) + 
  coord_flip() + 
  theme_classic() +
  # theme_pubr() + 
  
  labs(y = "Percent of total",
       x = "",
       fill = "Sex",
       title = "Age/sex pyramid of COVID-19 contacts",
       subtitle = paste0("n = ", contact_unknown_age, " with no age recorded, n = ", contact_unknown_sex, " with no sex recorded")) +
       # caption = paste0("Source: Go.Data Core Case Registration Module 
       #      Excludes cases without reported age (n = ", case_unknown_age, ") and sex (n = ", case_unknown_sex, ")")) 
  scale_x_discrete(limits = rev(drop_levels)) +
  theme(
    legend.title = element_text(size=10, face = "bold"),
    plot.title = element_text(size=12, face = "bold"),
    axis.ticks.y.left = element_line(size = 0.5, colour = "grey"),
    axis.title.y = element_text(size = 12),
    plot.subtitle = element_text(size=11),
    plot.caption = element_text(size = 8, face = "italic"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()) 
  
#############################################################
### occupation pie chart
############################################################
contacts$occupation <- as.factor(contacts$occupation)
contact_unknown_occupation <- sum(is.na(contacts$occupation) | contacts$occupation == "UNKNOWN")
contact_other_occupation <- sum(contacts$occupation == "OTHER")   ### why is this not working??
contact_occupation_breakdown <- contacts %>%
  # filter(!is.na(occupation),
  #        occupation != "OTHER") %>%
  group_by(occupation) %>%
  count() %>%
  arrange(desc(n)) 
# case_occupation_breakdown_plot_freq <- 
#   ggplot(subset(case_occupation_breakdown, !is.na(occupation)), aes(x = occupation, y = n)) +
#   geom_bar(stat = "identity") +
#   coord_flip() +
#   theme_classic()
color_count = length(unique(contacts$occupation))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))
contact_occupation_pie_chart <-
  ggplot(subset(contact_occupation_breakdown, !is.na(occupation) & !(occupation == "OTHER")), aes(x = "", y = n, fill = occupation)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start = 0) +
  theme_minimal() +
  scale_fill_manual(values = getPalette(color_count)) +
  labs(
       fill = "Occupation",
       title = "Occupational breakdown of COVID-19 contacts",
       subtitle = paste0("n = ", contact_unknown_occupation," without occupation recorded,", " n = ", contact_other_occupation," where 'OTHER'")
       ) +
  theme(axis.line = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        legend.position = "right",
        legend.title = element_text(size=10, face = "bold"),
        plot.title = element_text(size=12, face = "bold"),
        plot.subtitle = element_text(size=11),
        plot.caption = element_text(size = 8, face = "italic"))
#############################################################
### high risk groups
############################################################
contacts_high_risk <- contacts %>%
  mutate(
    health_worker_yes = case_when(occupation == "HEALTH_CARE_WORKER" |
                              occupation == "HEALTH_LABORATORY_WORKER" ~ TRUE,
                              TRUE ~ FALSE),
    health_worker_unknown = case_when(occupation == "UNKNOWN" |
                              is.na(occupation) ~ TRUE,
                              TRUE ~ FALSE),
    
    pregnant_yes = case_when(str_detect(pregnancy_status, "YES_") ~ TRUE,
                              TRUE ~ FALSE),
    
        pregnant_unknown = case_when(is.na(pregnancy_status) ~ TRUE,
                              TRUE ~ FALSE),
    
    high_risk_yes = case_when(risk_level == "3_HIGH" ~ TRUE,
                              TRUE ~ FALSE),
    
            risk_unknown = case_when(is.na(risk_level) ~ TRUE,
                              TRUE ~ FALSE)
    
  ) %>%
  summarize(health_worker_yes = sum(health_worker_yes),
            health_worker_unknown = sum(health_worker_unknown),
            pregnant_yes = sum(pregnant_yes),
            pregnant_unknown = sum(pregnant_unknown),
            high_risk_yes = sum(high_risk_yes),
            risk_unknown = sum(risk_unknown),
            total = nrow(contacts)) %>%
    mutate(
         health_worker_no = total - health_worker_yes - health_worker_unknown,
         pregnant_no = total - pregnant_yes - pregnant_unknown,
         high_risk_no = total - high_risk_yes - risk_unknown) %>%
  pivot_longer(-total,
    names_to = "category", values_to = "count") %>%
  
  mutate(risk_factor = case_when(str_detect(category,"health_worker") ~ "Health Worker",
                                str_detect(category,"pregnant") ~ "Pregnant",
                                 str_detect(category,"risk") ~ "Risk Level = `High`")
                      ) %>%
    mutate(category = case_when(str_detect(category,"_yes") ~ "Yes",
                               str_detect(category,"_no") ~ "No",
                                str_detect(category,"_unknown") ~ "Unknown")
                      ) %>%
  
  mutate(prop = (count/total*100))
contacts_high_risk$category<-factor(contacts_high_risk$category, levels=c('Unknown','No','Yes'), ordered = TRUE)
plot_contacts_high_risk <- 
  ggplot(contacts_high_risk, aes(x = risk_factor, y = count, fill = category)) + 
  geom_col() +
  coord_flip() +
  labs(x = " ",
       y = "# of contacts",
       title = "Groups of interest among registered cases",
       subtitle = "Proportion of records with relevant fields marked YES") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12, face = "bold"),
        plot.subtitle = element_text(size = 11)) +
  scale_fill_manual(
    values=c(
      "Yes" = "#ff5c33", 
      "No" = "#c2d6d6",
      "Unknown" = custom_grey0),
    guide = guide_legend(reverse = TRUE))
  
#########################################
# contact_age_breakdown_over_time_plot
plot_contacts_by_reg
age_pyramid_contact
contact_occupation_pie_chart
plot_contacts_high_risk
```

### Other

KEY PERFORMANCE INDICATORS {data-icon="fa-chart-line"} 
=====================================================

Row {data-height=200}
-------------------------------------

### New Cases From Contact List
```{r perc_from_known_contact_last7d, echo = FALSE}

valueBox(paste0(perc_from_known_contact_last7d,"%"), 
         caption = "New Cases among known contacts, last 7d",
         color =  custom_grey0)
```

### New Cases Unlinked to Source of Infection
```{r perc_cases_without_epilink_last7d, echo = FALSE}

perc_cases_no_epi_link_last7d <-
  round((cases_no_epi_link_last7d / cases_reg_last7d)*100, digits = 1)
valueBox(paste0(perc_cases_no_epi_link_last7d,"%"),  
         caption = "New cases with no epi-link, last 7d",
         color = custom_grey0)
```

### New cases reported within 24h of specimen collection
```{r kpi_3, echo = FALSE}
valueBox("75%", 
         caption = "New cases reported within 24h of specimen collection",
         color = custom_grey0)
```

### New cases interviewed within 24h of reporting 
```{r kpi_4, echo = FALSE}
valueBox("67%", 
         caption = "New cases interviewed within 24h of reporting",
         color = custom_grey0)
```

### Contacts notified within 24h of listing 
```{r kpi_5, echo = FALSE}
valueBox("88%", 
         caption = "% of contacts notified within 24h of listing",
         color = custom_grey0)
```

### New (symptomatic) cases tested and interviewed within 3 days of symptom onset
```{r kpi_6, echo = FALSE}
valueBox("57%", 
         caption = "% of New (symptomatic) cases tested and interviewed within 3 days of symptom onset",
         color = custom_grey0)
```

### Cases whose contacts are followed within 48h
```{r kpi_7, echo = FALSE}
valueBox("80%", 
         caption = "% Cases whose contacts are followed within 48h",
         color = custom_grey0)
```

### Median contacts per case
```{r kpi_8, echo = FALSE}
valueBox("4.5", 
         caption = "Median contacts per case",
         color = custom_grey0)
```

### Case interviews eliciting zero contacts
```{r kpi_9, echo = FALSE}
valueBox("4%", 
         caption = "% of case interviews eliciting zero contacts",
         color = custom_grey0)
```

### Median time from exposure of contact to contact notification
```{r kpi_10, echo = FALSE}
valueBox("4 days", 
         caption = "Median time from exposure of contact to contact notification",
         color = custom_grey0)
```

### Proportion of contacts symptomatic upon notification
```{r kpi_11, echo = FALSE}
valueBox("52%", 
         caption = "% of contacts symptomatic upon notification",
         color = custom_grey0)
```

Row {.tabset data-height=800}
-------------------------------------

### By Admin 1
```{r contact_kpi_table, fig.width=10, fig.height=7}
tab_contact_status <- contact_linelist_status %>%
  group_by(admin_1_name) %>%
  summarize(
    total_reg_contacts = n(),
    contact_reg_last7d = sum(date_of_reporting >= prev_7_date),
    contact_reg_prev_last7d = sum(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date), # add perc:change
    total_contacts_became_case = sum(follow_up_status == "BECAME_CASE"), # % Became case
    total_active_contacts = sum(follow_up_status == "UNDER_FOLLOW_UP"),
    seen = sum(seen_with_signs + seen_without_signs), # add perc_seen
    # seen_with_signs = sum(seen_with_signs), 
    # seen_without_signs = sum(seen_without_signs),
    # missed = sum(missed),
    # no_action = sum(no_action),
    # second_week = sum(second_week_followup),
    # first_week = sum(first_week_followup),
    lost_to_followup = sum(lost_to_followup), # add perc_seen
    never_seen = sum(never_seen) # add perc_never_seen
            ) %>%
  mutate(
         perc_change_7d_contacts = round((contact_reg_last7d - contact_reg_prev_last7d)/contact_reg_prev_last7d*100,digits=1),
         perc_became_case = round(total_contacts_became_case*100 / total_reg_contacts,digits=1),
         perc_seen = round(seen*100 / total_active_contacts,digits=1),
         perc_not_yet_seen = round(never_seen*100 / total_active_contacts,digits=1),
         perc_lost_to_followup = round(lost_to_followup*100 / total_active_contacts,digits=1)) %>%
  arrange(admin_1_name) %>%
  select(
    `Admin 1` = admin_1_name,
    `Total Registered contacts` = total_reg_contacts,
    `% Became case` = perc_became_case,
    `New Contacts, Last 7d` = contact_reg_last7d,
    `% Weekly Change` = perc_change_7d_contacts,
    `Active contacts` = total_active_contacts,
    `% Followed` = perc_seen,
    `% Followed within 48hrs` = perc_seen,
    `% Not yet followed` = perc_not_yet_seen,
    `% Lost to follow up` = perc_lost_to_followup
  ) 
formattable_tab_contact_status <-tab_contact_status %>%
  
  mutate(
    `Admin 1` = formatter("span", style = ~ formattable::style(
      color = ifelse(`Admin 1` == "Non rapporté", "red", "grey"),
      font.weight = "bold",font.style = "italic"))(`Admin 1`),
    `New Contacts, Last 7d` = color_bar(custom_blue0)(`New Contacts, Last 7d`),
    `% Became case`= color_tile("white", "grey")(`% Became case`),
    `% Lost to follow up`= color_tile("white", "orange")(`% Lost to follow up`),
    `% Followed`= color_tile("white", custom_green0)(`% Followed`), 
    `% Not yet followed`= color_tile("white", custom_red)(`% Not yet followed`)
       ) %>%
  # select(`Superviseur`, everything()) %>%
  kable("html", escape = F, align =c("l","c","c","c","c","c","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 2, 
                     "Contact registration" = 4,
                     "Contact follow-up" = 4))
formattable_tab_contact_status
```

### By Admin 2

```{r contact_kpi_table_2, fig.width=10, fig.height=7}
tab_contact_status_2 <- contact_linelist_status %>%
  # filter(!is.na(admin_2_name)) %>%
  group_by(admin_2_name) %>%
  summarize(
    total_reg_contacts = n(),
    contact_reg_last7d = sum(date_of_reporting >= prev_7_date),
    contact_reg_prev_last7d = sum(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date), # add perc:change
    total_contacts_became_case = sum(follow_up_status == "BECAME_CASE"), # % Became case
    total_active_contacts = sum(follow_up_status == "UNDER_FOLLOW_UP"),
    seen = sum(seen_with_signs + seen_without_signs), # add perc_seen
    # seen_with_signs = sum(seen_with_signs), 
    # seen_without_signs = sum(seen_without_signs),
    # missed = sum(missed),
    # no_action = sum(no_action),
    # second_week = sum(second_week_followup),
    # first_week = sum(first_week_followup),
    lost_to_followup = sum(lost_to_followup), # add perc_seen
    never_seen = sum(never_seen) # add perc_never_seen
            ) %>%
  mutate(
         perc_change_7d_contacts = round((contact_reg_last7d - contact_reg_prev_last7d)/contact_reg_prev_last7d*100,digits=1),
         perc_became_case = round(total_contacts_became_case*100 / total_reg_contacts,digits=1),
         perc_seen = round(seen*100 / total_active_contacts,digits=1),
         perc_not_yet_seen = round(never_seen*100 / total_active_contacts,digits=1),
         perc_lost_to_followup = round(lost_to_followup*100 / total_active_contacts,digits=1)) %>%
  arrange(admin_2_name) %>%
  select(
    `Admin 2` = admin_2_name,
    `Total Registered contacts` = total_reg_contacts,
    `% Became case` = perc_became_case,
    `New Contacts, Last 7d` = contact_reg_last7d,
    `% Weekly Change` = perc_change_7d_contacts,
    `Active contacts` = total_active_contacts,
    `% Followed` = perc_seen,
    `% Followed within 48hrs` = perc_seen,
    `% Not yet followed` = perc_not_yet_seen,
    `% Lost to follow up` = perc_lost_to_followup
  ) 
formattable_tab_contact_status_2 <-tab_contact_status_2 %>%
  
  mutate(
    `Admin 2` = formatter("span", style = ~ formattable::style(
      color = ifelse(`Admin 2` == "Non rapporté", "red", "grey"),
      font.weight = "bold",font.style = "italic"))(`Admin 2`),
    `New Contacts, Last 7d` = color_bar(custom_grey0)(`New Contacts, Last 7d`),
    `% Became case`= color_tile("white", "grey")(`% Became case`),
    `% Lost to follow up`= color_tile("white", "grey")(`% Lost to follow up`),
    `% Followed`= color_tile("white", "grey")(`% Followed`), 
    `% Not yet followed`= color_tile("white", custom_red)(`% Not yet followed`)
       ) %>%
  # select(`Superviseur`, everything()) %>%
  kable("html", escape = F, align =c("l","c","c","c","c","c","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 2, 
                     "Contact registration" = 4,
                     "Contact follow-up" = 4))
formattable_tab_contact_status_2
```

### By Contact Tracer

```{r contact_kpi_table_3, fig.width=10, fig.height=7}

tab_contact_status_user <- contact_linelist_status %>%
  group_by(user_name) %>%
  summarize(
    total_reg_contacts = n(),
    contact_reg_last7d = sum(date_of_reporting >= prev_7_date),
    contact_reg_prev_last7d = sum(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date), # add perc:change
    total_contacts_became_case = sum(follow_up_status == "BECAME_CASE"), # % Became case
    total_active_contacts = sum(follow_up_status == "UNDER_FOLLOW_UP"),
    seen = sum(seen_with_signs + seen_without_signs), # add perc_seen
    # seen_with_signs = sum(seen_with_signs), 
    # seen_without_signs = sum(seen_without_signs),
    # missed = sum(missed),
    # no_action = sum(no_action),
    # second_week = sum(second_week_followup),
    # first_week = sum(first_week_followup),
    lost_to_followup = sum(lost_to_followup), # add perc_seen
    never_seen = sum(never_seen) # add perc_never_seen
            ) %>%
  mutate(
         perc_change_7d_contacts = round((contact_reg_last7d - contact_reg_prev_last7d)/contact_reg_prev_last7d*100,digits=1),
         perc_became_case = round(total_contacts_became_case*100 / total_reg_contacts,digits=1),
         perc_seen = round(seen*100 / total_active_contacts,digits=1),
         perc_not_yet_seen = round(never_seen*100 / total_active_contacts,digits=1),
         perc_lost_to_followup = round(lost_to_followup*100 / total_active_contacts,digits=1)) %>%
  arrange(user_name) %>%
  select(
    `Contact Tracer` = user_name,
    `Total Registered contacts` = total_reg_contacts,
    `% Became case` = perc_became_case,
    `New Contacts, Last 7d` = contact_reg_last7d,
    `% Weekly Change` = perc_change_7d_contacts,
    `Active contacts` = total_active_contacts,
    `% Followed` = perc_seen,
    `% Followed within 48hrs` = perc_seen,
    `% Not yet followed` = perc_not_yet_seen,
    `% Lost to follow up` = perc_lost_to_followup
  ) 

formattable_tab_contact_status_user <-tab_contact_status_user %>%
  
  mutate(
    `Contact Tracer` = formatter("span", style = ~ formattable::style(
      color = ifelse(`Contact Tracer` == "Non rapporté", "red", "grey"),
      font.weight = "bold",font.style = "italic"))(`Contact Tracer`),
    `New Contacts, Last 7d` = color_bar(custom_grey0)(`New Contacts, Last 7d`),
    `% Became case`= color_tile("white", "grey")(`% Became case`),
    `% Lost to follow up`= color_tile("white", "grey")(`% Lost to follow up`),
    `% Followed`= color_tile("white", "grey")(`% Followed`), 
    `% Not yet followed`= color_tile("white", custom_red)(`% Not yet followed`)
       ) %>%
  # select(`Superviseur`, everything()) %>%
  kable("html", escape = F, align =c("l","c","c","c","c","c","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 2, 
                     "Contact registration" = 4,
                     "Contact follow-up" = 4))
formattable_tab_contact_status_user
```

### By Team

```{r contact_kpi_table_team, fig.width=10, fig.height=7}

tab_contact_status_team <- contact_linelist_status %>%
  group_by(team_name) %>%
  summarize(
    total_reg_contacts = n(),
    contact_reg_last7d = sum(date_of_reporting >= prev_7_date),
    contact_reg_prev_last7d = sum(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date), # add perc:change
    total_contacts_became_case = sum(follow_up_status == "BECAME_CASE"), # % Became case
    total_active_contacts = sum(follow_up_status == "UNDER_FOLLOW_UP"),
    seen = sum(seen_with_signs + seen_without_signs), # add perc_seen
    # seen_with_signs = sum(seen_with_signs), 
    # seen_without_signs = sum(seen_without_signs),
    # missed = sum(missed),
    # no_action = sum(no_action),
    # second_week = sum(second_week_followup),
    # first_week = sum(first_week_followup),
    lost_to_followup = sum(lost_to_followup), # add perc_seen
    never_seen = sum(never_seen) # add perc_never_seen
            ) %>%
  mutate(
         perc_change_7d_contacts = round((contact_reg_last7d - contact_reg_prev_last7d)/contact_reg_prev_last7d*100,digits=1),
         perc_became_case = round(total_contacts_became_case*100 / total_reg_contacts,digits=1),
         perc_seen = round(seen*100 / total_active_contacts,digits=1),
         perc_not_yet_seen = round(never_seen*100 / total_active_contacts,digits=1),
         perc_lost_to_followup = round(lost_to_followup*100 / total_active_contacts,digits=1)) %>%
  arrange(team_name) %>%
  select(
    `Team` = team_name,
    `Total Registered contacts` = total_reg_contacts,
    `% Became case` = perc_became_case,
    `New Contacts, Last 7d` = contact_reg_last7d,
    `% Weekly Change` = perc_change_7d_contacts,
    `Active contacts` = total_active_contacts,
    `% Followed` = perc_seen,
    `% Followed within 48hrs` = perc_seen,
    `% Not yet followed` = perc_not_yet_seen,
    `% Lost to follow up` = perc_lost_to_followup
  ) 

formattable_tab_contact_status_team <-tab_contact_status_team %>%
  
  mutate(
    `Team` = formatter("span", style = ~ formattable::style(
      color = ifelse(`Team` == "Non rapporté", "red", "grey"),
      font.weight = "bold",font.style = "italic"))(`Team`),
    `New Contacts, Last 7d` = color_bar(custom_grey0)(`New Contacts, Last 7d`),
    `% Became case`= color_tile("white", "grey")(`% Became case`),
    `% Lost to follow up`= color_tile("white", "grey")(`% Lost to follow up`),
    `% Followed`= color_tile("white", "grey")(`% Followed`), 
    `% Not yet followed`= color_tile("white", custom_red)(`% Not yet followed`)
       ) %>%
  # select(`Superviseur`, everything()) %>%
  kable("html", escape = F, align =c("l","c","c","c","c","c","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 2, 
                     "Contact registration" = 4,
                     "Contact follow-up" = 4))

formattable_tab_contact_status_team

```

DATA QUALITY {data-icon="fa-clipboard"} 
=====================================================

```{r data_completion, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}
# TO DO:
#  1. Add composite avg for relationship data completion
#  2. change colors so that they are diff, and so that lines match bars
#  3. think about adding events???
#overall data completion by variable 
# CASES
completion_table_cases <- cases %>%
  
  transmute(
    case_id = case_when(is.na(visual_id) ~ FALSE, TRUE ~ TRUE),
    classification = case_when(is.na(classification) ~ FALSE, TRUE ~ TRUE),
    gender = case_when(is.na(gender) ~ FALSE, TRUE ~ TRUE),
    age = case_when(is.na(age) ~ FALSE, TRUE ~ TRUE),
    occupation = case_when(is.na(occupation) ~ FALSE, TRUE ~ TRUE),
    pregnancy_status = case_when(is.na(pregnancy_status) ~ FALSE, TRUE ~ TRUE),
    outcome = case_when(is.na(outcome) ~ FALSE, TRUE ~ TRUE),
    date_of_infection = case_when(is.na(date_of_infection) ~ FALSE, TRUE ~ TRUE),
    date_become_case = case_when(is.na(date_become_case) ~ FALSE, TRUE ~ TRUE),
    date_of_onset = case_when(is.na(date_of_onset) ~ FALSE, TRUE ~ TRUE),
    date_of_outcome = case_when(is.na(date_of_outcome) ~ FALSE, TRUE ~ TRUE),
    admin_1 = case_when(is.na(admin_1_name) ~ FALSE, TRUE ~ TRUE),
    admin_2 = case_when(is.na(admin_2_name) ~ FALSE, TRUE ~ TRUE),
    # admin_3 = case_when(is.na(admin_3_name) ~ FALSE, TRUE ~ TRUE),
    address = case_when(is.na(address) ~ FALSE, TRUE ~ TRUE),
    city = case_when(is.na(city) ~ FALSE, TRUE ~ TRUE),
    postal_code = case_when(is.na(postal_code) ~ FALSE, TRUE ~ TRUE),
    telephone = case_when(is.na(telephone) ~ FALSE, TRUE ~ TRUE),
    vaccinated = case_when(is.na(vaccinated) ~ FALSE, TRUE ~ TRUE),
    isolation = case_when(is.na(isolated) ~ FALSE, TRUE ~ TRUE),
    hospitalization = case_when(is.na(hospitalized) ~ FALSE, TRUE ~ TRUE),
    risk_level = case_when(is.na(risk_level) ~ FALSE, TRUE ~ TRUE)
    )
    
completion_table_cases_pivot <- completion_table_cases %>%
  mtabulate() %>%
  tibble::rownames_to_column("variable") %>%
  pivot_longer(-variable, names_to = "completed", values_to = "count") %>%
  arrange(variable, desc(count))
plot_completion_table_cases <- 
  ggplot(completion_table_cases_pivot, aes(x = variable, y = count, fill = completed)) + 
  geom_col() +
  coord_flip() +
  labs(x = " ",
       y = "# of records",
       title = "Overall Data completion rate across core COVID-19 case variables",
       subtitle = "Not including configurable questionnaire variables") +
  theme(axis.line = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        legend.position = "right",
        legend.title = element_text(size=10, face = "bold"),
        plot.title = element_text(size=12, face = "bold"),
        plot.subtitle = element_text(size=11),
        plot.caption = element_text(size = 8, face = "italic")) +
  scale_completion +
  theme_classic()

######################################################################
# Contacts
completion_table_contacts <- contacts %>%
  transmute(
    contact_id = case_when(is.na(visual_id) ~ FALSE, TRUE ~ TRUE),
    gender = case_when(is.na(gender) ~ FALSE, TRUE ~ TRUE),
    age = case_when(is.na(age) ~ FALSE, TRUE ~ TRUE),
    occupation = case_when(is.na(occupation) ~ FALSE, TRUE ~ TRUE),
    follow_up_status = case_when(is.na(follow_up_status) ~ FALSE, TRUE ~ TRUE),
    pregnancy_status = case_when(is.na(pregnancy_status) ~ FALSE, TRUE ~ TRUE),
    risk_level = case_when(is.na(risk_level) ~ FALSE, TRUE ~ TRUE),
    date_of_last_contact = case_when(is.na(date_of_last_contact) ~ FALSE, TRUE ~ TRUE),
    admin_1 = case_when(is.na(admin_1_name) ~ FALSE, TRUE ~ TRUE),
    admin_2 = case_when(is.na(admin_2_name) ~ FALSE, TRUE ~ TRUE),
    # admin_3 = case_when(is.na(admin_3_name) ~ FALSE, TRUE ~ TRUE),
    address = case_when(is.na(address) ~ FALSE, TRUE ~ TRUE),
    city = case_when(is.na(city) ~ FALSE, TRUE ~ TRUE),
    telephone = case_when(is.na(telephone) ~ FALSE, TRUE ~ TRUE),
    email = case_when(is.na(email) ~ FALSE, TRUE ~ TRUE),
    postal_code = case_when(is.na(postal_code) ~ FALSE, TRUE ~ TRUE),
    risk_level = case_when(is.na(risk_level) ~ FALSE, TRUE ~ TRUE),
    vaccinated = case_when(is.na(vaccinated) ~ FALSE, TRUE ~ TRUE),
    
    # exposure_type = case_when(is.na(exposure_type) ~ FALSE, TRUE ~ TRUE),
    context_of_transmission = case_when(is.na(relationship_context_of_transmission) ~ FALSE, TRUE ~ TRUE),
    exposure_type = case_when(is.na(relationship_exposure_type) ~ FALSE, TRUE ~ TRUE),
    exposure_frequency = case_when(is.na(relationship_exposure_frequency) ~ FALSE, TRUE ~ TRUE),
    exposure_duration = case_when(is.na(relationship_exposure_duration) ~ FALSE, TRUE ~ TRUE),
    certainty_level = case_when(is.na(relationship_certainty_level) ~ FALSE, TRUE ~ TRUE),
    cluster = case_when(is.na(relationship_cluster_id) ~ FALSE, TRUE ~ TRUE)
    )
    
completion_table_contacts_pivot <- completion_table_contacts %>%
  mtabulate() %>%
  tibble::rownames_to_column("variable") %>%
  pivot_longer(-variable, names_to = "completed", values_to = "count") %>%
  arrange(variable, desc(count))
plot_completion_table_contacts <- 
  ggplot(completion_table_contacts_pivot, aes(x = variable, y = count, fill = completed)) + 
  geom_col() +
  coord_flip() +
  labs(x = " ",
       y = "# of records",
       title = "Overall Data completion rate across core COVID-19 contact registration variables",
       subtitle = "Not including configurable questionnaire variables") +
  theme(plot.title = element_blank(),
        plot.subtitle = element_text(size = 10)) +
  scale_completion +
  theme_minimal()   

###########################################################################3333
# # avg data completion over time
# completion_rate_by_week <- case_linelist_essential %>%
#   filter(date_of_reporting <= prev_7_date) %>%
#   mutate(week_of_reporting = cut(date_of_reporting, breaks = "week")) %>%
#   mutate(week_of_reporting = as.Date(week_of_reporting)) %>%
#   group_by(week_of_reporting) %>%
#   summarize(mean_case_completion = round(mean(100-perc_na),digits=1)) %>%
#   ungroup() 
# 
# completion_rates_by_week <- contact_linelist_essential %>%
#   filter(date_of_reporting > "2020-01-01") %>%
#   filter(date_of_reporting < prev_7_date) %>%
#   mutate(week_of_reporting = cut(date_of_reporting, breaks = "2 weeks")) %>%
#   mutate(week_of_reporting = as.Date(week_of_reporting)) %>%
#   group_by(week_of_reporting) %>%
#   summarize(mean_contact_completion = round(mean(100-perc_na),digits=1))  %>%
#   ungroup() %>%
#   inner_join(completion_rate_by_week, by = "week_of_reporting") %>%
#   rename(contact_registration = mean_contact_completion,
#          case_registration = mean_case_completion) %>%
#   pivot_longer(-week_of_reporting, names_to = "type", values_to = "mean")
# plot_completion_rates_by_week <-
#   ggplot(completion_rates_by_week, aes(x = week_of_reporting,  y = mean, color = type )) +
#   geom_line(size = 1.3) +
#   scale_x_date(date_labels = "%b-%d",
#                date_breaks = "2 weeks") +
#   ylim(0,100) +
#   theme_classic() +
#     labs(x = "",
#        y = "Avg % Data Completion",
#        x = "Week of Reporting",
#        title = "Data Completion Over Time",
#        subtitle = "Avg across core case contact variables") +
#     theme(
#         legend.position = "right",
#         legend.title = element_text(size=10, face = "bold"),
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11),
#         plot.caption = element_text(size = 8, face = "italic"),
#         axis.text.x = element_text(angle = 45, hjust = 1)) 
plot_completion_table_cases
plot_completion_table_contacts
# plot_completion_rates_by_week
```

MAPS {data-icon="fa-map-marker"}
=====================================================

```{r maps, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}
# ###################################################################
# # cumul map cases
# 
# #Manual Categories
# splits <- c(-1,0.01,250,500,750,1000,10000) #Specify Breakpoints for categories
# cat.labels <- c("0","1-249","250-499","500-749","750-999","1000+") #Text Labels for the Categories in the Map Legend
# my_colors2 <- c("white",brewer.pal(length(cat.labels)-1,"Reds"))
# shp.adm2.cases.contacts$class_of_cases2 <- cut(shp.adm2.cases.contacts$cases, splits, right=FALSE)
# # table(shp.adm2.cases.contacts$class_of_cases2)
# 
# cumul_case_map_admin_2 <- ggplot(data=shp.adm2.cases.contacts) +
#   geom_sf(aes(fill=class_of_cases2)) +
#   scale_fill_manual(name="Cases", values=my_colors2, labels=cat.labels, drop=FALSE) +
#   labs(title = "Cumulative COVID-19 Cases by District, Canton Vaud",
#        subtitle = "Confirmed & probable") +
#   theme_void() +
#   theme(legend.position = "right",
#         legend.title = element_text(size=10, face = "bold"),
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11),
#         plot.caption = element_text(size = 8, face = "italic"))
# 
# 
# cases_gps <- cases %>%
#   select(uuid, lat, long, date_of_reporting) %>%
#   filter(!is.na(lat) & !is.na(long)) 
# 
# 
# map_cases_gps <- ggplot(data = shp.adm2) +
#   geom_sf() +
#   geom_point(data=subset(cases_gps, date_of_reporting >= before_prev_7_date), aes(x=long, y=lat), color="red") +
#   geom_point(data=subset(cases_gps, date_of_reporting >= prev_7_date), aes(x=long, y=lat), color=custom_blue) +
#   coord_sf(xlim = c(6, 11), ylim = c(45, 48), expand = FALSE) +
#   labs(title = "New COVID-19 Cases, Last 7d",
#        subtitle = "Confirmed & probable") +
#   theme_void() +
#     theme(
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11))
# 
# 
# ###################################################################3333
# # cumul map contacts
# 
# #Manual Categories
# splits <- c(-1,0.01,250,500,750,1000,10000) #Specify Breakpoints for categories
# cat.labels <- c("0","1-249","250-499","500-749","750-999","1000+") #Text Labels for the Categories in the Map Legend
# my_colors2 <- c("white",brewer.pal(length(cat.labels)-1,"Blues"))
# shp.adm2.cases.contacts$class_of_contacts2 <- cut(shp.adm2.cases.contacts$contacts, splits, right=FALSE)
# 
# cumul_contact_map_admin_2 <- ggplot(data=shp.adm2.cases.contacts) +
#   geom_sf(aes(fill=class_of_contacts2)) +
#   scale_fill_manual(name="Contacts", values=my_colors2, labels=cat.labels, drop=FALSE) +
#   labs(title = "COVID-19 Registered Contacts by District, Canton Vaud",
#        subtitle = "Currently under follow up") +
#   theme_void() +
#   theme(legend.position = "right",
#         legend.title = element_text(size=10, face = "bold"),
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11),
#         plot.caption = element_text(size = 8, face = "italic"))
# 
# contacts_gps <- contacts %>%
#   # filter(contact_status == "BECAME_CASE") %>%
#   select(uuid, lat, long, date_of_reporting, contact_status) %>%
#   filter(!is.na(lat) & !is.na(long)) 
# 
# 
# map_contacts_gps <- ggplot(data = shp.adm2) +
#   geom_sf() +
#   geom_point(data = subset(contacts_gps,contact_status = "UNDER_FOLLOW_UP"), aes(x=long, y=lat), color = custom_blue) +
#   # geom_point(data=subset(contacts_gps, date_of_reporting >= before_prev_7_date), aes(x=long, y=lat))  +
#   coord_sf(xlim = c(6, 11), ylim = c(45, 48), expand = FALSE) +
#   labs(title = "Active COVID-19 Contacts",
#        subtitle = "Currently under follow up") +
#   theme_void() +
#     theme(
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11))
#   
# 
# 
# 
# cumul_case_map_admin_2
# map_cases_gps
# cumul_contact_map_admin_2
# map_contacts_gps
```

LABS {data-icon="fa-vial"} 
=====================================================

```{r labs, echo=FALSE}
```


USERS / ADMINISTRATION {data-icon="fa-globe"} 
=====================================================

```{r user_details, echo = FALSE}
### here put a formattable with users, area, last login, total records submitted, roles
```

```{r resources, echo = FALSE}
### here put links to github, community of practice, etc
```
