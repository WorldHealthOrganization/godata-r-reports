---
title: "Go.Data Summary Dashboard - DEMO V1"
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
    flexdashboard::flex_dashboard:
      theme: cosmo
      orientation: rows
      
---


<style>                     
.navbar {
  background-color:#4db0a0;
  border-color:white;
}
.navbar-brand {
color:white!important;
}
</style>   

<style type="text/css">

.chart-title {  /* chart_title  */
   font-size: 18px

</style>



```{r setup, include=FALSE}

pacman::p_load(
  tidyverse,    # includes many packages for tidy data wrangling and presentation
  janitor, # tables and data cleaning
  here,
  rio,
  lubridate,
  htmlwidgets,
  flexdashboard,
  formattable,
  kableExtra,
  RColorBrewer, 
  viridis,
  qdapTools,
  incidence2
)



```

```{r load_data, include = FALSE}
cases <- rio::import(here::here("data", "clean", "cases_clean.rds")) %>%
  as_tibble()

contacts <- rio::import(here::here("data", "clean", "contacts_clean.rds")) %>%
  as_tibble()

contacts_of_contacts <- rio::import(here::here("data", "clean", "contacts_of_contacts_clean.rds")) %>%
  as_tibble()

relationships <- rio::import(here::here("data", "clean", "relationships_clean.rds")) %>%
  as_tibble()

lab_results <- rio::import(here::here("data", "clean", "lab_results_clean.rds")) %>% as_tibble() %>%
  as_tibble()

events <- rio::import(here::here("data", "clean", "events_clean.rds")) %>%
  as_tibble()

followups <- rio::import(here::here("data", "clean", "followups_clean.rds")) %>%
  as_tibble()

users <- rio::import(here::here("data", "clean", "users_clean.rds")) %>%
  as_tibble()

teams <- rio::import(here::here("data", "clean", "teams_clean.rds")) %>%
  as_tibble()

locations <- rio::import(here::here("data", "clean", "locations_clean.rds")) %>%
  as_tibble()


```

```{r define_time_periods, include = FALSE}
database_date <- Sys.Date()  
database_week <- isoweek(database_date)
prev_1_date <- database_date - 1
prev_7_date <- prev_1_date - 7
before_prev_7_date <- prev_7_date -7
```


```{r themes, include = FALSE}
# Create cusotmized color scales for graphs and tables

custom_grey0 = "#ADADAD"
custom_grey = "#818181"

case_blue = "#607EFC"
contact_green = "#02956D"


scale_status <- scale_fill_manual(
    "Status",
    values = c(seen            = "#71CA97",
               not_seen        = "#5d6d75",
               not_performed   = "#D3C9C6",
               seen_no_signs   = "#A0E2BD",
               seen_with_signs = "#E94B25",
               missed          = "#020202"),
                
    labels = c(seen            = "Seen",
               not_seen        = "Not Seen",
               not_performed   = "Not Performed",
               seen_no_signs   = "Seen OK",
               seen_with_signs = "Seen Not OK",
               missed          = "Missed"))

statuscols <- c(missed = 0, 
                seen_with_signs = 0, 
                seen_no_signs = 0,
                not_seen = 0,
                not_performed = 0)

completioncols <- c(completed = 0,
                    partial = 0,
                    not_attempted = 0)

scale_completion <- scale_fill_manual(
  name = "Completed",
  values = c("#E94B25",
             "#ABADAB"),
  labels = c("Incomplete",
             "Completed"))

scale_risk_factors <- scale_fill_manual(
  name = "Status",
  values = c("#ff5c33",
             "#c2d6d6",
             custom_grey0),
  
  labels = c("Yes",
             "No",
             "Unknown"))


scale_classification <- scale_fill_manual(
  "Classification",
  values = c(CONFIRMED             = "#F55927",
             NOT_A_CASE_DISCARDED  = "#DADAD9",
             PROBABLE              = "#5C77B6",
             SUSPECT               = "#6CBBC6"),
  
  labels = c(CONFIRMED             = "Confirmed",
             NOT_A_CASE_DISCARDED  = "Not A Case",
             PROBABLE              = "Probable",
             SUSPECT               = "Suspect"))


scale_test <- scale_fill_manual(
  "Tests",
  values = c(POSITIVE        = "#F55927",
             NEGATIVE    = "#DADAD9",
             PENDING = "#F6DDCC",
             INCONCLUSIVE = "#FBEEE6"
             
  ),
  
  labels = c(POSITIVE        = "Positive",
             NEGATIVE     = "Negative",
             PENDING     = "Pending",
             INCONCLUSIVE     = "Unknown/Inconclusive"
             
  ))


scale_day <- ggplot2::scale_x_date(breaks = "3 days",
                                   expand=c(0,0),
                                   date_label = format("%d %b %Y"))

```

```{r contact_linelist_status, include = FALSE}

# user list to join
user_namelist <- users %>%
  mutate(user_name = paste0(first_name, " ", last_name)) %>%
  select(id,user_name)

team_namelist <- teams %>%
  select(id, team_name = name)


# visit status from followups
contacts_seen_ever <- followups %>%
  filter(followup_status == "SEEN_OK" | followup_status == "SEEN_NOT_OK") %>%
  arrange(contact_id, desc(date)) %>%
  distinct(contact_id, .keep_all = TRUE) %>%
  select(contact_id,
         contact_visual_id, 
         date_of_last_followup_seen = date)

contacts_last_visit <- followups %>%
  arrange(contact_id, desc(date)) %>%
  distinct(contact_id, .keep_all = TRUE) %>%
  select(contact_id,
         contact_visual_id, 
         date_of_last_followup = date,
         status_of_last_followup = followup_status)

contact_linelist_status <- contacts %>%
  left_join(user_namelist, by = c("updated_by" = "id")) %>%
  left_join(team_namelist, by = c("follow_up_team_id" = "id")) %>%
  left_join(select(contacts_seen_ever, contact_id, date_of_last_followup_seen), by = c("id" = "contact_id")) %>%
  left_join(select(contacts_last_visit, contact_id, date_of_last_followup, status_of_last_followup), by = c("id" = "contact_id")) %>%
  
  # mutate_if(is_character, funs(na_if(.,""))) %>%
  mutate(days_since_followup_seen = difftime(database_date,
                                             date_of_last_followup_seen, 
                                             units = "day")) %>%
  mutate(days_since_exp = difftime(database_date,
                                   date_of_last_contact, 
                                   units = "day")) %>%
  mutate(seen_with_signs = case_when(
    status_of_last_followup == "SEEN_NOT_OK" ~ TRUE,
    # & date_of_last_followup == database_date ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(seen_without_signs = case_when(
    status_of_last_followup == "SEEN_OK" ~ TRUE,
    # & date_of_last_followup == database_date ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(missed = case_when(
    status_of_last_followup == "MISSED" ~ TRUE,
    # & date_of_last_followup == database_date ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(no_action = case_when(
    (status_of_last_followup == "NOT_ATTEMPTED" |
       status_of_last_followup == "NOT_PERFORMED" ) ~ TRUE,
    # & date_of_last_followup == database_date ~ TRUE,
    TRUE ~ FALSE)) %>%
  # mutate(vaccine = (contact_status_linelist$contact_id %in% contacts_vaccinated_ever$contact_id)) %>%
  mutate(lost_to_followup = case_when(
    days_since_followup_seen >= 3 ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(second_week_followup = case_when(
    days_since_exp < 15
    & days_since_exp >= 8 ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(first_week_followup = case_when(
    days_since_exp < 8 ~ TRUE,
    TRUE ~ FALSE)) %>%
  mutate(never_seen = !(id %in% contacts_seen_ever$contact_id)) 


```

```{r value_boxes, include = FALSE}

## Total Cases
total_cases_reg <- cases %>%
  filter(classification != "NOT_A_CASE_DISCARDED") %>%
  count()


## New cases, last 7 days
cases_reg_last7d <- cases %>%
  filter(date_of_reporting >= prev_7_date) %>%
  count()

cases_reg_prev_last7d <- cases %>%
  filter(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date) %>%
  count()

perc_change_7d <- round(((cases_reg_last7d - cases_reg_prev_last7d) / cases_reg_prev_last7d)*100, digits = 0) 
perc_change_7d <- sprintf("%+3.0f %%", perc_change_7d)

# Total cases CONFIRMED
total_cases_confirmed <- cases %>%
  filter(classification == "CONFIRMED") %>%
  count()

# Total cases PROBABLE
total_cases_probable <- cases %>%
  filter(classification == "PROBABLE") %>%
  count()

# Total cases SUSPECT
total_cases_suspect <- cases %>%
  filter(classification == "SUSPECT") %>%
  count()

# Cases from contact list
cases_from_known_contact <- cases %>%
  filter(was_contact) %>%
  count()

cases_from_known_contact_last7d <- cases %>%
  filter(date_of_reporting >= prev_7_date) %>%
  filter(was_contact) %>%
  count()

perc_from_known_contact <-
  round((cases_from_known_contact / total_cases_reg)*100, digits = 1)

perc_from_known_contact_last7d <-
  round((cases_from_known_contact_last7d / cases_reg_last7d)*100, digits = 1)

# Cases died / recovered
cases_died <- cases %>%
  filter(outcome == "DECEASED") %>%
  count()

cases_recovered <- cases %>%
  filter(outcome == "RECOVERED") %>%
  count()

# Cases hospitalized
cases_hospitalized <- cases %>%
  filter(hospitalized) %>%
  count()

# Cases with No Epi Link
cases_no_epi_link <- cases %>%
  filter(!known_epi_link) %>%
  count()

# Cases with No Epi Link, last 7d
cases_no_epi_link_last7d <- cases %>%
  filter(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date) %>%
  filter(!known_epi_link) %>%
  count()

# Cases 0 contacts
cases_no_contacts <- cases %>%
  filter(no_contacts == 0) %>%
  count()


# Active contacts
total_contacts_reg <- contact_linelist_status %>%
  count() 

contacts_active <- contact_linelist_status %>%
  filter(follow_up_status == "UNDER_FOLLOW_UP") %>%
  count() 

# New contacts listed, last 7 days
contacts_reg_last7d <- contacts %>%
  filter(date_of_reporting >= prev_7_date) %>%
  count()

contacts_reg_prev_last7d <- contacts %>%
  filter(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date) %>%
  count()

perc_change_7d_contacts <- round(((contacts_reg_last7d - contacts_reg_prev_last7d) / contacts_reg_prev_last7d)*100, digits = 0) 
perc_change_7d_contacts <- sprintf("%+3.0f %%", perc_change_7d_contacts)

# Contacts followed
contacts_active_followed <- contact_linelist_status %>%
  filter(follow_up_status == "UNDER_FOLLOW_UP") %>%
  filter(seen_with_signs | seen_without_signs) %>%
  count()

perc_contacts_active_followed <-
  round((contacts_active_followed/contacts_active)*100,digits = 1)

# Contacts lost to follow up
contacts_active_ltfu <- contact_linelist_status %>%
  filter(follow_up_status == "UNDER_FOLLOW_UP") %>%
  filter(lost_to_followup) %>%
  count()

perc_contacts_active_ltfu <-
  round((contacts_active_ltfu/contacts_active)*100,digits = 1)


```


SUMMARY {data-icon="fa-globe"} 
=====================================================

Row {data-height=125}
-------------------------------------

### Confirmed Cases
```{r total_cases_confirmed, echo = FALSE}

valueBox(total_cases_confirmed, 
         icon = "fa-user-plus",
         caption = "Confirmed",
         color = case_blue)
```

### Probable Cases
```{r total_cases_probable, echo = FALSE}

valueBox(total_cases_probable, 
         caption = "Probable",
         color = custom_grey)
```

### Suspect Cases
```{r total_cases_suspect, echo = FALSE}

valueBox(total_cases_suspect, 
         caption = "Suspect",
         color = custom_grey)
```


### Cases from Contact List
```{r perc_from_known_contact, echo = FALSE}

valueBox(cases_from_known_contact, 
         caption = "From known contacts",
         color =  custom_grey)
```

### Total Contacts
```{r total_contacts_reg, echo = FALSE}

valueBox(total_contacts_reg, 
         icon = "fa-users",
         caption = "Listed contacts",
         color = contact_green)
```


### Active Contacts
```{r total_active_contacts_reg, echo = FALSE}

valueBox(contacts_active, 
         caption = "Active contacts",
         color = custom_grey)
```

### Followed Contacts
```{r contacts_active_followed, echo = FALSE}

valueBox(contacts_active_followed, 
         caption = "Followed",
         color = custom_grey)
```

### LTFU Contacts
```{r contacts_active_ltfu, echo = FALSE}

valueBox(contacts_active_ltfu, 
         caption = "Lost to Follow Up",
         color = custom_grey)
```


Row {.tabset data-height=875}
------------------------------------

### CASE AND CONTACT REGISTRATION

```{r summary_case, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}

source("plot_cases.R")
source("plot_contacts.R")

epicurve_date_of_onset
plot_contacts_by_day
epicurve_date_of_reporting
plot_contacts_per_case


```

### CONTACT FOLLOW-UP STATUS

```{r summary_contact_fu, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}

source("plot_contacts.R")

plot_daily_followup_status


```

### LABS

```{r summary_lab, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}



```



DEMOGRAPHICS {data-icon="fa-users"} 
=====================================================

Row {.tabset}
-------------------------------------

### Case Demographics

```{r case_demographics, fig.width=9, fig.height=6, out.width="50%"}

source("plot_cases.R")
case_age_breakdown_over_time_plot
age_pyramid_case
case_occupation_pie_chart
plot_cases_high_risk


```

### Contact Demographics

```{r contact_demographics, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}

source("plot_contacts.R")
contact_age_breakdown_over_time_plot
age_pyramid_contact
contact_occupation_pie_chart
plot_contacts_high_risk


```

### Other

PERFORMANCE MONITORING {data-icon="fa-chart-line"} 
=====================================================

Row {data-height=200}
-------------------------------------

### Cases Unlinked to Source of Infection
```{r perc_cases_without_epilink, echo = FALSE}

perc_cases_no_epi_link <-
  round((cases_no_epi_link / total_cases_reg)*100, digits = 1)
valueBox(paste0(perc_cases_no_epi_link,"%"),  
         caption = "Cases with no epi-link",
         color = custom_grey0)
```

### Cases reported within 24h of specimen collection
```{r kpi_3, echo = FALSE}
valueBox("75%", 
         caption = "Cases reported within 24h of specimen collection",
         color = custom_grey0)
```

### Cases interviewed within 24h of reporting 
```{r kpi_4, echo = FALSE}
valueBox("67%", 
         caption = "Cases interviewed within 24h of reporting",
         color = custom_grey0)
```

### Contacts notified within 24h of listing 
```{r kpi_5, echo = FALSE}
valueBox("88%", 
         caption = "Contacts notified within 24h of listing",
         color = custom_grey0)
```

### Cases tested and interviewed within 3 days of symptom onset
```{r kpi_6, echo = FALSE}
valueBox("57%", 
         caption = "Cases tested and interviewed within 3 days of symptom onset",
         color = custom_grey0)
```

### Cases whose contacts are followed within 48h
```{r kpi_7, echo = FALSE}
valueBox("80%", 
         caption = "Cases whose contacts are followed within 48h",
         color = custom_grey0)
```

### Median contacts per case
```{r kpi_8, echo = FALSE}
valueBox("4.5", 
         caption = "Median contacts per case",
         color = custom_grey0)
```

### Case interviews eliciting zero contacts
```{r kpi_9, echo = FALSE}
valueBox("4%", 
         caption = "% of case interviews eliciting zero contacts",
         color = custom_grey0)
```

### Median time from exposure of contact to contact notification
```{r kpi_10, echo = FALSE}
valueBox("4 days", 
         caption = "Median time from exposure of contact to contact notification",
         color = custom_grey0)
```

### Proportion of contacts symptomatic upon notification
```{r kpi_11, echo = FALSE}
valueBox("52%", 
         caption = "% of contacts symptomatic upon notification",
         color = custom_grey0)
```

Row {.tabset data-height=800}
-------------------------------------

### KPIs by Admin 1
```{r contact_kpi_table, fig.width=10, fig.height=7}

tab_contact_status <- contact_linelist_status %>%
  group_by(admin_1_name) %>%
  summarize(
    total_reg_contacts = n(),
    contact_reg_last7d = sum(date_of_reporting >= prev_7_date),
    contact_reg_prev_last7d = sum(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date),
    total_contacts_became_case = sum(follow_up_status == "BECAME_CASE"), # % Became case
    total_active_contacts = sum(follow_up_status == "UNDER_FOLLOW_UP"),
    seen = sum(seen_with_signs + seen_without_signs), # add perc_seen
    # seen_with_signs = sum(seen_with_signs), 
    # seen_without_signs = sum(seen_without_signs),
    # missed = sum(missed),
    # no_action = sum(no_action),
    # second_week = sum(second_week_followup),
    # first_week = sum(first_week_followup),
    lost_to_followup = sum(lost_to_followup), # add perc_seen
    never_seen = sum(never_seen) # add perc_never_seen
            ) %>%
  mutate(
         perc_change_7d_contacts = round((contact_reg_last7d - contact_reg_prev_last7d)/contact_reg_prev_last7d*100,digits=1),
         perc_became_case = round(total_contacts_became_case*100 / total_reg_contacts,digits=1),
         perc_seen = round(seen*100 / total_active_contacts,digits=1),
         perc_not_yet_seen = round(never_seen*100 / total_active_contacts,digits=1),
         perc_lost_to_followup = round(lost_to_followup*100 / total_active_contacts,digits=1)) %>%
  arrange(admin_1_name) %>%
  select(
    `Admin 1` = admin_1_name,
    `Total Registered contacts` = total_reg_contacts,
    `% Became case` = perc_became_case,
    `New Contacts, Last 7d` = contact_reg_last7d,
    `% Weekly Change` = perc_change_7d_contacts,
    `Active contacts` = total_active_contacts,
    `% Followed` = perc_seen,
    `% Followed within 48hrs` = perc_seen,
    `% Not yet followed` = perc_not_yet_seen,
    `% Lost to follow up` = perc_lost_to_followup
  ) 
formattable_tab_contact_status <-tab_contact_status %>%
  
  mutate(
    `Admin 1` = formatter("span", style = ~ formattable::style(
      color = ifelse(`Admin 1` == "Unknown", "red", "grey"),
      font.weight = "bold",font.style = "italic"))(`Admin 1`),
    # `New Contacts, Last 7d` = color_bar(case_blue)(`New Contacts, Last 7d`),
    `% Became case`= color_tile("white", "grey")(`% Became case`),
    `% Lost to follow up`= color_tile("white", "orange")(`% Lost to follow up`),
    `% Followed`= color_tile("white", contact_green)(`% Followed`), 
    `% Not yet followed`= color_tile("white", "red")(`% Not yet followed`)
       ) %>%
  kable("html", escape = F, align =c("l","c","c","c","c","c","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 2, 
                     "Contact registration" = 4,
                     "Contact follow-up" = 4))

formattable_tab_contact_status
```

### KPIs by Admin 2

```{r contact_kpi_table_2, fig.width=10, fig.height=7}
tab_contact_status_2 <- contact_linelist_status %>%
  # filter(!is.na(admin_2_name)) %>%
  group_by(admin_2_name) %>%
  summarize(
    total_reg_contacts = n(),
    contact_reg_last7d = sum(date_of_reporting >= prev_7_date),
    contact_reg_prev_last7d = sum(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date), # add perc:change
    total_contacts_became_case = sum(follow_up_status == "BECAME_CASE"), # % Became case
    total_active_contacts = sum(follow_up_status == "UNDER_FOLLOW_UP"),
    seen = sum(seen_with_signs + seen_without_signs), # add perc_seen
    # seen_with_signs = sum(seen_with_signs), 
    # seen_without_signs = sum(seen_without_signs),
    # missed = sum(missed),
    # no_action = sum(no_action),
    # second_week = sum(second_week_followup),
    # first_week = sum(first_week_followup),
    lost_to_followup = sum(lost_to_followup), # add perc_seen
    never_seen = sum(never_seen) # add perc_never_seen
            ) %>%
  mutate(
         perc_change_7d_contacts = round((contact_reg_last7d - contact_reg_prev_last7d)/contact_reg_prev_last7d*100,digits=1),
         perc_became_case = round(total_contacts_became_case*100 / total_reg_contacts,digits=1),
         perc_seen = round(seen*100 / total_active_contacts,digits=1),
         perc_not_yet_seen = round(never_seen*100 / total_active_contacts,digits=1),
         perc_lost_to_followup = round(lost_to_followup*100 / total_active_contacts,digits=1)) %>%
  arrange(admin_2_name) %>%
  select(
    `Admin 2` = admin_2_name,
    `Total Registered contacts` = total_reg_contacts,
    `% Became case` = perc_became_case,
    `New Contacts, Last 7d` = contact_reg_last7d,
    `% Weekly Change` = perc_change_7d_contacts,
    `Active contacts` = total_active_contacts,
    `% Followed` = perc_seen,
    `% Followed within 48hrs` = perc_seen,
    `% Not yet followed` = perc_not_yet_seen,
    `% Lost to follow up` = perc_lost_to_followup
  ) 
formattable_tab_contact_status_2 <-tab_contact_status_2 %>%
  
  mutate(
    `Admin 2` = formatter("span", style = ~ formattable::style(
      color = ifelse(`Admin 2` == "Unknown", "red", "grey"),
      font.weight = "bold",font.style = "italic"))(`Admin 2`),
    # `New Contacts, Last 7d` = color_bar(case_blue)(`New Contacts, Last 7d`),
    `% Became case`= color_tile("white", "grey")(`% Became case`),
    `% Lost to follow up`= color_tile("white", "orange")(`% Lost to follow up`),
    `% Followed`= color_tile("white", contact_green)(`% Followed`), 
    `% Not yet followed`= color_tile("white", "red")(`% Not yet followed`)
       ) %>%
  # select(`Superviseur`, everything()) %>%
  kable("html", escape = F, align =c("l","c","c","c","c","c","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 2, 
                     "Contact registration" = 4,
                     "Contact follow-up" = 4))
formattable_tab_contact_status_2
```

### By Contact Tracer

```{r contact_kpi_table_3, fig.width=10, fig.height=7}

tab_contact_status_user <- contact_linelist_status %>%
  group_by(user_name) %>%
  summarize(
    total_reg_contacts = n(),
    contact_reg_last7d = sum(date_of_reporting >= prev_7_date),
    contact_reg_prev_last7d = sum(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date), # add perc:change
    total_contacts_became_case = sum(follow_up_status == "BECAME_CASE"), # % Became case
    total_active_contacts = sum(follow_up_status == "UNDER_FOLLOW_UP"),
    seen = sum(seen_with_signs + seen_without_signs), # add perc_seen
    # seen_with_signs = sum(seen_with_signs), 
    # seen_without_signs = sum(seen_without_signs),
    # missed = sum(missed),
    # no_action = sum(no_action),
    # second_week = sum(second_week_followup),
    # first_week = sum(first_week_followup),
    lost_to_followup = sum(lost_to_followup), # add perc_seen
    never_seen = sum(never_seen) # add perc_never_seen
            ) %>%
  mutate(
         perc_change_7d_contacts = round((contact_reg_last7d - contact_reg_prev_last7d)/contact_reg_prev_last7d*100,digits=1),
         perc_became_case = round(total_contacts_became_case*100 / total_reg_contacts,digits=1),
         perc_seen = round(seen*100 / total_active_contacts,digits=1),
         perc_not_yet_seen = round(never_seen*100 / total_active_contacts,digits=1),
         perc_lost_to_followup = round(lost_to_followup*100 / total_active_contacts,digits=1)) %>%
  arrange(user_name) %>%
  select(
    `Contact Tracer` = user_name,
    `Total Registered contacts` = total_reg_contacts,
    `% Became case` = perc_became_case,
    `New Contacts, Last 7d` = contact_reg_last7d,
    `% Weekly Change` = perc_change_7d_contacts,
    `Active contacts` = total_active_contacts,
    `% Followed` = perc_seen,
    `% Followed within 48hrs` = perc_seen,
    `% Not yet followed` = perc_not_yet_seen,
    `% Lost to follow up` = perc_lost_to_followup
  ) 

formattable_tab_contact_status_user <-tab_contact_status_user %>%
  
   mutate(
    `Contact Tracer` = formatter("span", style = ~ formattable::style(
      color = ifelse(`Contact Tracer` == "Unknown", "red", "grey"),
      font.weight = "bold",font.style = "italic"))(`Contact Tracer`),
    # `New Contacts, Last 7d` = color_bar(case_blue)(`New Contacts, Last 7d`),
    `% Became case`= color_tile("white", "grey")(`% Became case`),
    `% Lost to follow up`= color_tile("white", "orange")(`% Lost to follow up`),
    `% Followed`= color_tile("white", contact_green)(`% Followed`), 
    `% Not yet followed`= color_tile("white", "red")(`% Not yet followed`)
       ) %>%
  # select(`Superviseur`, everything()) %>%
  kable("html", escape = F, align =c("l","c","c","c","c","c","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 2, 
                     "Contact registration" = 4,
                     "Contact follow-up" = 4))
formattable_tab_contact_status_user
```

### KPIs by Team

```{r contact_kpi_table_team, fig.width=10, fig.height=7}

tab_contact_status_team <- contact_linelist_status %>%
  group_by(team_name) %>%
  summarize(
    total_reg_contacts = n(),
    contact_reg_last7d = sum(date_of_reporting >= prev_7_date),
    contact_reg_prev_last7d = sum(date_of_reporting >= before_prev_7_date & date_of_reporting < prev_7_date), # add perc:change
    total_contacts_became_case = sum(follow_up_status == "BECAME_CASE"), # % Became case
    total_active_contacts = sum(follow_up_status == "UNDER_FOLLOW_UP"),
    seen = sum(seen_with_signs + seen_without_signs), # add perc_seen
    # seen_with_signs = sum(seen_with_signs), 
    # seen_without_signs = sum(seen_without_signs),
    # missed = sum(missed),
    # no_action = sum(no_action),
    # second_week = sum(second_week_followup),
    # first_week = sum(first_week_followup),
    lost_to_followup = sum(lost_to_followup), # add perc_seen
    never_seen = sum(never_seen) # add perc_never_seen
            ) %>%
  mutate(
         perc_change_7d_contacts = round((contact_reg_last7d - contact_reg_prev_last7d)/contact_reg_prev_last7d*100,digits=1),
         perc_became_case = round(total_contacts_became_case*100 / total_reg_contacts,digits=1),
         perc_seen = round(seen*100 / total_active_contacts,digits=1),
         perc_not_yet_seen = round(never_seen*100 / total_active_contacts,digits=1),
         perc_lost_to_followup = round(lost_to_followup*100 / total_active_contacts,digits=1)) %>%
  arrange(team_name) %>%
  select(
    `Team` = team_name,
    `Total Registered contacts` = total_reg_contacts,
    `% Became case` = perc_became_case,
    `New Contacts, Last 7d` = contact_reg_last7d,
    `% Weekly Change` = perc_change_7d_contacts,
    `Active contacts` = total_active_contacts,
    `% Followed` = perc_seen,
    `% Followed within 48hrs` = perc_seen,
    `% Not yet followed` = perc_not_yet_seen,
    `% Lost to follow up` = perc_lost_to_followup
  ) 

formattable_tab_contact_status_team <-tab_contact_status_team %>%
  
  mutate(
    `Team` = formatter("span", style = ~ formattable::style(
      color = ifelse(`Team` == "Unknown", "red", "grey"),
      font.weight = "bold",font.style = "italic"))(`Team`),
    # `New Contacts, Last 7d` = color_bar(custom_grey0)(`New Contacts, Last 7d`),
    `% Became case`= color_tile("white", "grey")(`% Became case`),
    `% Lost to follow up`= color_tile("white", "grey")(`% Lost to follow up`),
    `% Followed`= color_tile("white", "grey")(`% Followed`), 
    `% Not yet followed`= color_tile("white", "red")(`% Not yet followed`)
       ) %>%
  # select(`Superviseur`, everything()) %>%
  kable("html", escape = F, align =c("l","c","c","c","c","c","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 2, 
                     "Contact registration" = 4,
                     "Contact follow-up" = 4))

formattable_tab_contact_status_team

```
### Data Completion

```{r data_completion, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}
# TO DO:
#  1. Add composite avg for relationship data completion
#  2. change colors so that they are diff, and so that lines match bars
#  3. think about adding events???
#overall data completion by variable 
# CASES
completion_table_cases <- cases %>%
  
  transmute(
    case_id = case_when(is.na(visual_id) ~ FALSE, TRUE ~ TRUE),
    classification = case_when(is.na(classification) ~ FALSE, TRUE ~ TRUE),
    gender = case_when(is.na(gender) ~ FALSE, TRUE ~ TRUE),
    age = case_when(is.na(age) ~ FALSE, TRUE ~ TRUE),
    occupation = case_when(is.na(occupation) ~ FALSE, TRUE ~ TRUE),
    pregnancy_status = case_when(is.na(pregnancy_status) ~ FALSE, TRUE ~ TRUE),
    outcome = case_when(is.na(outcome) ~ FALSE, TRUE ~ TRUE),
    date_of_infection = case_when(is.na(date_of_infection) ~ FALSE, TRUE ~ TRUE),
    date_become_case = case_when(is.na(date_become_case) ~ FALSE, TRUE ~ TRUE),
    date_of_onset = case_when(is.na(date_of_onset) ~ FALSE, TRUE ~ TRUE),
    date_of_outcome = case_when(is.na(date_of_outcome) ~ FALSE, TRUE ~ TRUE),
    admin_1 = case_when(is.na(admin_1_name) ~ FALSE, TRUE ~ TRUE),
    admin_2 = case_when(is.na(admin_2_name) ~ FALSE, TRUE ~ TRUE),
    # admin_3 = case_when(is.na(admin_3_name) ~ FALSE, TRUE ~ TRUE),
    address = case_when(is.na(address) ~ FALSE, TRUE ~ TRUE),
    city = case_when(is.na(city) ~ FALSE, TRUE ~ TRUE),
    postal_code = case_when(is.na(postal_code) ~ FALSE, TRUE ~ TRUE),
    telephone = case_when(is.na(telephone) ~ FALSE, TRUE ~ TRUE),
    vaccinated = case_when(is.na(vaccinated) ~ FALSE, TRUE ~ TRUE),
    isolation = case_when(is.na(isolated) ~ FALSE, TRUE ~ TRUE),
    hospitalization = case_when(is.na(hospitalized) ~ FALSE, TRUE ~ TRUE),
    risk_level = case_when(is.na(risk_level) ~ FALSE, TRUE ~ TRUE)
    )
    
completion_table_cases_pivot <- completion_table_cases %>%
  mtabulate() %>%
  tibble::rownames_to_column("variable") %>%
  pivot_longer(-variable, names_to = "completed", values_to = "count") %>%
  arrange(variable, desc(count))
plot_completion_table_cases <- 
  ggplot(completion_table_cases_pivot, aes(x = variable, y = count, fill = completed)) + 
  geom_col() +
  coord_flip() +
  labs(x = " ",
       y = "# of records",
       title = "Overall Data completion rate across core COVID-19 case variables",
       subtitle = "Not including configurable questionnaire variables") +
  theme(axis.line = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        legend.position = "right",
        legend.title = element_text(size=10, face = "bold"),
        plot.title = element_text(size=12, face = "bold"),
        plot.subtitle = element_text(size=11),
        plot.caption = element_text(size = 8, face = "italic")) +
  scale_completion +
  theme_classic()

######################################################################
# Contacts
completion_table_contacts <- contacts %>%
  transmute(
    contact_id = case_when(is.na(visual_id) ~ FALSE, TRUE ~ TRUE),
    gender = case_when(is.na(gender) ~ FALSE, TRUE ~ TRUE),
    age = case_when(is.na(age) ~ FALSE, TRUE ~ TRUE),
    occupation = case_when(is.na(occupation) ~ FALSE, TRUE ~ TRUE),
    follow_up_status = case_when(is.na(follow_up_status) ~ FALSE, TRUE ~ TRUE),
    pregnancy_status = case_when(is.na(pregnancy_status) ~ FALSE, TRUE ~ TRUE),
    risk_level = case_when(is.na(risk_level) ~ FALSE, TRUE ~ TRUE),
    date_of_last_contact = case_when(is.na(date_of_last_contact) ~ FALSE, TRUE ~ TRUE),
    admin_1 = case_when(is.na(admin_1_name) ~ FALSE, TRUE ~ TRUE),
    admin_2 = case_when(is.na(admin_2_name) ~ FALSE, TRUE ~ TRUE),
    # admin_3 = case_when(is.na(admin_3_name) ~ FALSE, TRUE ~ TRUE),
    address = case_when(is.na(address) ~ FALSE, TRUE ~ TRUE),
    city = case_when(is.na(city) ~ FALSE, TRUE ~ TRUE),
    telephone = case_when(is.na(telephone) ~ FALSE, TRUE ~ TRUE),
    email = case_when(is.na(email) ~ FALSE, TRUE ~ TRUE),
    postal_code = case_when(is.na(postal_code) ~ FALSE, TRUE ~ TRUE),
    risk_level = case_when(is.na(risk_level) ~ FALSE, TRUE ~ TRUE),
    vaccinated = case_when(is.na(vaccinated) ~ FALSE, TRUE ~ TRUE),
    
    # exposure_type = case_when(is.na(exposure_type) ~ FALSE, TRUE ~ TRUE),
    context_of_transmission = case_when(is.na(relationship_context_of_transmission) ~ FALSE, TRUE ~ TRUE),
    exposure_type = case_when(is.na(relationship_exposure_type) ~ FALSE, TRUE ~ TRUE),
    exposure_frequency = case_when(is.na(relationship_exposure_frequency) ~ FALSE, TRUE ~ TRUE),
    exposure_duration = case_when(is.na(relationship_exposure_duration) ~ FALSE, TRUE ~ TRUE),
    certainty_level = case_when(is.na(relationship_certainty_level) ~ FALSE, TRUE ~ TRUE),
    cluster = case_when(is.na(relationship_cluster_id) ~ FALSE, TRUE ~ TRUE)
    )
    
completion_table_contacts_pivot <- completion_table_contacts %>%
  mtabulate() %>%
  tibble::rownames_to_column("variable") %>%
  pivot_longer(-variable, names_to = "completed", values_to = "count") %>%
  arrange(variable, desc(count))
plot_completion_table_contacts <- 
  ggplot(completion_table_contacts_pivot, aes(x = variable, y = count, fill = completed)) + 
  geom_col() +
  coord_flip() +
  labs(x = " ",
       y = "# of records",
       title = "Overall Data completion rate across core COVID-19 contact registration variables",
       subtitle = "Not including configurable questionnaire variables") +
  theme(plot.title = element_blank(),
        plot.subtitle = element_text(size = 10)) +
  scale_completion +
  theme_minimal()   

###########################################################################3333
# # avg data completion over time
# completion_rate_by_week <- case_linelist_essential %>%
#   filter(date_of_reporting <= prev_7_date) %>%
#   mutate(week_of_reporting = cut(date_of_reporting, breaks = "week")) %>%
#   mutate(week_of_reporting = as.Date(week_of_reporting)) %>%
#   group_by(week_of_reporting) %>%
#   summarize(mean_case_completion = round(mean(100-perc_na),digits=1)) %>%
#   ungroup() 
# 
# completion_rates_by_week <- contact_linelist_essential %>%
#   filter(date_of_reporting > "2020-01-01") %>%
#   filter(date_of_reporting < prev_7_date) %>%
#   mutate(week_of_reporting = cut(date_of_reporting, breaks = "2 weeks")) %>%
#   mutate(week_of_reporting = as.Date(week_of_reporting)) %>%
#   group_by(week_of_reporting) %>%
#   summarize(mean_contact_completion = round(mean(100-perc_na),digits=1))  %>%
#   ungroup() %>%
#   inner_join(completion_rate_by_week, by = "week_of_reporting") %>%
#   rename(contact_registration = mean_contact_completion,
#          case_registration = mean_case_completion) %>%
#   pivot_longer(-week_of_reporting, names_to = "type", values_to = "mean")
# plot_completion_rates_by_week <-
#   ggplot(completion_rates_by_week, aes(x = week_of_reporting,  y = mean, color = type )) +
#   geom_line(size = 1.3) +
#   scale_x_date(date_labels = "%b-%d",
#                date_breaks = "2 weeks") +
#   ylim(0,100) +
#   theme_classic() +
#     labs(x = "",
#        y = "Avg % Data Completion",
#        x = "Week of Reporting",
#        title = "Data Completion Over Time",
#        subtitle = "Avg across core case contact variables") +
#     theme(
#         legend.position = "right",
#         legend.title = element_text(size=10, face = "bold"),
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11),
#         plot.caption = element_text(size = 8, face = "italic"),
#         axis.text.x = element_text(angle = 45, hjust = 1)) 
plot_completion_table_cases
plot_completion_table_contacts
# plot_completion_rates_by_week
```

MAPS {data-icon="fa-map-marker"}
=====================================================

```{r maps, fig.width=9, fig.height=6, fig.show="hold", out.width="50%"}
# ###################################################################
# # cumul map cases
# 
# #Manual Categories
# splits <- c(-1,0.01,250,500,750,1000,10000) #Specify Breakpoints for categories
# cat.labels <- c("0","1-249","250-499","500-749","750-999","1000+") #Text Labels for the Categories in the Map Legend
# my_colors2 <- c("white",brewer.pal(length(cat.labels)-1,"Reds"))
# shp.adm2.cases.contacts$class_of_cases2 <- cut(shp.adm2.cases.contacts$cases, splits, right=FALSE)
# # table(shp.adm2.cases.contacts$class_of_cases2)
# 
# cumul_case_map_admin_2 <- ggplot(data=shp.adm2.cases.contacts) +
#   geom_sf(aes(fill=class_of_cases2)) +
#   scale_fill_manual(name="Cases", values=my_colors2, labels=cat.labels, drop=FALSE) +
#   labs(title = "Cumulative COVID-19 Cases by District, Canton Vaud",
#        subtitle = "Confirmed & probable") +
#   theme_void() +
#   theme(legend.position = "right",
#         legend.title = element_text(size=10, face = "bold"),
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11),
#         plot.caption = element_text(size = 8, face = "italic"))
# 
# 
# cases_gps <- cases %>%
#   select(uuid, lat, long, date_of_reporting) %>%
#   filter(!is.na(lat) & !is.na(long)) 
# 
# 
# map_cases_gps <- ggplot(data = shp.adm2) +
#   geom_sf() +
#   geom_point(data=subset(cases_gps, date_of_reporting >= before_prev_7_date), aes(x=long, y=lat), color="red") +
#   geom_point(data=subset(cases_gps, date_of_reporting >= prev_7_date), aes(x=long, y=lat), color=custom_blue) +
#   coord_sf(xlim = c(6, 11), ylim = c(45, 48), expand = FALSE) +
#   labs(title = "New COVID-19 Cases, Last 7d",
#        subtitle = "Confirmed & probable") +
#   theme_void() +
#     theme(
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11))
# 
# 
# ###################################################################3333
# # cumul map contacts
# 
# #Manual Categories
# splits <- c(-1,0.01,250,500,750,1000,10000) #Specify Breakpoints for categories
# cat.labels <- c("0","1-249","250-499","500-749","750-999","1000+") #Text Labels for the Categories in the Map Legend
# my_colors2 <- c("white",brewer.pal(length(cat.labels)-1,"Blues"))
# shp.adm2.cases.contacts$class_of_contacts2 <- cut(shp.adm2.cases.contacts$contacts, splits, right=FALSE)
# 
# cumul_contact_map_admin_2 <- ggplot(data=shp.adm2.cases.contacts) +
#   geom_sf(aes(fill=class_of_contacts2)) +
#   scale_fill_manual(name="Contacts", values=my_colors2, labels=cat.labels, drop=FALSE) +
#   labs(title = "COVID-19 Registered Contacts by District, Canton Vaud",
#        subtitle = "Currently under follow up") +
#   theme_void() +
#   theme(legend.position = "right",
#         legend.title = element_text(size=10, face = "bold"),
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11),
#         plot.caption = element_text(size = 8, face = "italic"))
# 
# contacts_gps <- contacts %>%
#   # filter(contact_status == "BECAME_CASE") %>%
#   select(uuid, lat, long, date_of_reporting, contact_status) %>%
#   filter(!is.na(lat) & !is.na(long)) 
# 
# 
# map_contacts_gps <- ggplot(data = shp.adm2) +
#   geom_sf() +
#   geom_point(data = subset(contacts_gps,contact_status = "UNDER_FOLLOW_UP"), aes(x=long, y=lat), color = custom_blue) +
#   # geom_point(data=subset(contacts_gps, date_of_reporting >= before_prev_7_date), aes(x=long, y=lat))  +
#   coord_sf(xlim = c(6, 11), ylim = c(45, 48), expand = FALSE) +
#   labs(title = "Active COVID-19 Contacts",
#        subtitle = "Currently under follow up") +
#   theme_void() +
#     theme(
#         plot.title = element_text(size=12, face = "bold"),
#         plot.subtitle = element_text(size=11))
#   
# 
# 
# 
# cumul_case_map_admin_2
# map_cases_gps
# cumul_contact_map_admin_2
# map_contacts_gps
```

LABS {data-icon="fa-vial"} 
=====================================================

```{r labs, echo=FALSE}
```



CHAINS OF TRANSMISSION {data-icon="fa-chart-network"} 
=====================================================

```{r chains, echo=FALSE}

source("plot_chains.R")
plot_bubble

```

USERS / ADMINISTRATION {data-icon="fa-globe"} 
=====================================================

```{r user_details, echo = FALSE}
### here put a formattable with users, area, last login, total records submitted, roles
  
tab_users <- users %>%
    mutate(user_name = paste0(first_name, " ", last_name)) %>%
    arrange(desc(datetime_last_login)) %>%
  # add in concat of roles columns
  select(
    `Name` = user_name,
    # add team name
    `Email` = email,
    `Institution` = institution_name,
    `Last Login` = datetime_last_login,
    `User Since` = datetime_created_at
    # add number of total cases created
    # add number of current "active" cases 
    # add number of total contacts created
    # add number of current "active" contacts
    ) 

formattable_tab_users <-tab_users %>%
  
  kable("html", escape = F, align =c("l","c","c","c","c")) %>%
  kable_styling("hover", full_width = FALSE) %>%
  add_header_above(c(" " = 3, 
                     "Recent Activity" = 2))

formattable_tab_users

```

```{r resources, echo = FALSE}
### here put links to github, community of practice, etc
```
